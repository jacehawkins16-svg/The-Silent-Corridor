<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Silent Corridor: Expanded Edition</title>
    <link rel="icon" type="image/png" href="icon.png">
    <style>

/* Global Styles & Atmosphere */
body {
    /* 1. AMBIENT BACKGROUND: Dark Red/Black (Default for Low Graphics) - This is the normal background */
    background-color: #110000; 
    color: #aaa; 
    font-family: 'Courier New', Courier, monospace;
    display: flex;
    justify-content: center;
    align-items: center; 
    height: 100vh;
    width: 100vw; 
    margin: 0;
    padding: 0; 
    overflow: hidden; 
    
    position: relative;
    z-index: 0; 
    
    /* Flashlight Variables */
    --x: 50vw; 
    --y: 50vh; 
    --flashlight-size: 300px; 

    /* Set a fixed dark background, NOT a gradient, to serve as the ambient color */
    background: #110000; 
    background-attachment: fixed;
    transition: none !important; 
}

/* NEW: Background Distortion on Better Graphics */
body.better-graphics-active {
    /* Subtle overall distortion filter */
    filter: hue-rotate(2deg) contrast(0.98); 
    transition: filter 1.0s ease-in-out; 
}


/* 2. body::before provides the WHITE/RED light color over the ambient background */
body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 10; 
    pointer-events: none; 
    
    /* THE LIGHT COLOR: Soft white center with red edge fading to transparent (reveals ambient body background) */
    background: radial-gradient(
        circle var(--flashlight-size) at var(--x) var(--y), 
        rgba(255, 255, 255, 0.15) 0%,     /* Bright center */
        rgba(255, 85, 85, 0.05) 50%,    /* Red glow */
        transparent 100% 
    );
    background-blend-mode: overlay; 
}

/* 3. body::after is the BLACK SHADOW MASK with a transparent hole */
body::after {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 12; 
    pointer-events: none;

    background-color: #000; 
    opacity: 0.95; 
    
    /* THE MASK: Creates a transparent hole in the shadow layer */
    mask-image: radial-gradient(
        circle var(--flashlight-size) at var(--x) var(--y),
        transparent 0%, 
        transparent 70%,
        black 100% 
    );
    -webkit-mask-image: radial-gradient(
        circle var(--flashlight-size) at var(--x) var(--y),
        transparent 0%,
        transparent 70%,
        black 100%
    );
}

/* --- Eye Tracking CSS - CREEPY VERSION --- */
#eye-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    /* Place eyes above the light source (z-index 10) but below the shadow mask (z-index 12) */
    z-index: 11; 
    pointer-events: none;
    
    /* NEW: Start invisible and fade in/out */
    opacity: 0; 
    transition: opacity 1.0s ease-in-out; 
}

.eye {
    position: absolute;
    width: 45px; /* Wider */
    height: 35px; /* Shorter for oval shape */
    background: #440000; /* Dark, unsettling sclera */
    /* Oval shape (width 50%, height 40%) */
    border-radius: 50% / 40%;
    border: 1px solid #770000;
    /* Subtle red glow/shadow for bloodshot/supernatural effect */
    box-shadow: 0 0 10px rgba(255, 50, 50, 0.4), 
                inset 0 0 5px rgba(255, 50, 50, 0.2); 
    /* Removed individual eye opacity transition, using container instead */
}

.eye-pupil {
    position: absolute;
    top: 50%;
    left: 50%;
    /* Keep it centered initially before JS moves it */
    transform: translate(-50%, -50%); 
    width: 8px; /* Narrow slit */
    height: 25px; /* Vertical slit length */
    background: #000; /* Pure black void */
    /* Slit shape */
    border-radius: 4px;
    box-shadow: 0 0 5px #ff5555; /* Creepy red glow around pupil */
}

.eye-pupil::after {
    /* Hidden: We use the whole element as the pupil/iris now */
    display: none; 
}


/* NEW: Camera Effect Overlay (for Better Graphics setting) */
#camera-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 50; 
    pointer-events: none; 
    opacity: 0; 
    transition: opacity 1.0s ease-in-out;
}

#camera-overlay.active {
    opacity: 1; 
    /* Camera Effect: Greenish noise, scan lines, and vignette */
    background: 
        /* 1. Subtle green/red vignette */
        radial-gradient(ellipse at center, rgba(0, 0, 0, 0) 0%, rgba(10, 0, 0, 0.2) 60%, rgba(0, 5, 0, 0.5) 100%),
        /* 2. Film grain/noise */
        repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(0, 0, 0, 0.2) 2px, rgba(0, 0, 0, 0.2) 3px),
        /* 3. Color tint */
        rgba(50, 0, 0, 0.1); 
    
    /* Distortion Effects */
    filter: brightness(1.2) contrast(1.1) hue-rotate(5deg) blur(0.5px);
    transform: scale(1.005);
}

/* NEW: Rain Effect Overlay */
#rain-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1; 
    pointer-events: none;
    background-image: url('rain.png');
    background-repeat: repeat; 
    background-size: 150px 150px; 
    /* REMOVED static opacity: now controlled by JS (0 for low, 0.2 for better) */
    transition: opacity 0.5s ease-out; /* Added transition for smooth hide/show */
    animation: fallingRain 0.5s linear infinite; 
}

@keyframes fallingRain {
    from {
        background-position: 0 0;
    }
    to {
        background-position: -300px 300px; 
    }
}

/* NEW: Blink Overlay */
#blink-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 60; /* Higher than all other elements */
    background-color: #000;
    opacity: 0; /* Start invisible */
    pointer-events: none;
    transition: none; /* No default transition */
}

/* Blink Animation */
@keyframes playerBlink {
    0% { opacity: 0; }
    50% { opacity: 1; } /* Fully closed */
    100% { opacity: 0; }
}

.is-blinking {
    animation: playerBlink 0.15s ease-in-out forwards; /* Very quick transition */
}


.container {
    width: 80vh; 
    height: 80vh; 
    max-width: 95%; 
    max-height: 95vh; 
    
    box-sizing: border-box;
    overflow-y: auto; 
    overflow-x: hidden; 
    
    text-align: left;
    line-height: 1.6;
    animation: none !important; 
    
    /* Default background for low graphics (75% opacity) */
    background-color: rgba(17, 0, 0, 0.75); 
    background-image: none; /* Ensure no gradient is present by default */
    
    padding: 20px; 
    border-radius: 5px;
    box-shadow: none; 
    position: relative; 
    transition: margin-left 0.5s, background 0.5s; /* Added background transition */
    
    /* FIX: Lowered Z-index from 13 to 11 so the Shadow Mask (z-index 12) can dim the content */
    z-index: 11; 
}

/* UPDATED: Special background for Better Graphics (15% opacity/85% transparent with fade) */
body.better-graphics-active .container {
    background-color: transparent; /* Must be transparent to allow gradient */
    background-image: radial-gradient(
        circle at center,
        rgba(50, 0, 0, 0.15) 0%,    /* Dark Red Center (15% opacity) */
        rgba(0, 0, 0, 0.15) 75%,    /* Black at 75% radius (15% opacity) */
        rgba(0, 0, 0, 0.0) 100%     /* Fully transparent at edge (fades into body ambient) */
    );
}
        h1 {
            color: #f55; 
            text-align: center;
            border-bottom: 1px solid #f55; 
            padding-bottom: 10px;
            text-transform: uppercase;
        }
        
        /* NEW: Added transition for the game title to fade in */
        #game-title {
            opacity: 1; /* Default to visible in case JS fails */
            transition: opacity 1.5s ease-in-out;
        }

        /* --- Screen Management --- */
        .screen {
            display: none;
            opacity: 1;
            /* MODIFIED: Reduced transition time from 2.0s to 1.0s */
            transition: opacity 1.0s ease-in-out; 
            box-sizing: border-box; 
        }
        .screen.active {
            display: block;
        }
        
        .fade-out {
            opacity: 0 !important; 
        }

/* --- Start Menu & Animation Styles --- */
#start-screen, #settings-screen { 
    text-align: center;
    padding: 10vh 40px; 
}

        #start-title {
            font-size: 2.5em;
            margin-bottom: 40px;
            border-bottom: none; 
            padding-bottom: 0;
            animation-name: titleMove; 
            animation-duration: 4s;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
            animation-direction: alternate;
        }
        @keyframes titleMove {
            0% { transform: translateX(-10px) rotate(-1.5deg); }
            50% { transform: translateX(10px) rotate(1.5deg); }
            100% { transform: translateX(-10px) rotate(-1.5deg); }
        }

        #start-button, #endings-button, #settings-button { 
            max-width: 300px;
            margin: 10px auto; 
            font-size: 1.2em;
            padding: 15px 30px;
            border-color: #f55; 
            width: auto !important; 
        }

        /* --- Game Screen Elements --- */
#game-screen {
    opacity: 0; 
    /* MODIFIED: Reduced transition time from 2.0s to 1.0s */
    transition: opacity 1.0s ease-in-out; 
}
#game-screen.active {
    display: block; 
    opacity: 1; 
}

#story-text, #choices {
    opacity: 0; 
    transition: opacity 1.5s ease-in-out; 
}
        
        #story-text {
            margin-top: 20px;
            font-size: 1em;
            min-height: 200px; 
        }
        
        #story-text h2 { 
            text-align: center;
            font-size: 1.5em;
            color: #f55; 
            margin-top: 20px;
            border-bottom: none;
            text-transform: none;
        }
        
        #story-text p.description {
            margin-bottom: 30px;
            font-style: italic;
        }
        
        /* Interaction Buttons */
        .choice-btn {
            background-color: transparent;
            border: 1px solid #f55; 
            color: #f55; 
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            transition: color 0.3s, background-color 0.3s, border-color 0.3s;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }
        .choice-btn:hover {
            color: #fff; 
            border-color: #fff; 
            background-color: #220000; 
        }
        
        /* Game Over State */
        .game-over h1, .game-over .choice-btn {
            color: #ff0000; 
            border-color: #ff0000; 
        }
        .game-over .choice-btn:hover {
            background-color: #330000; 
        }
        
/* --- Settings Screen Styles --- */
#settings-screen {
    padding-top: 20px;
}
.setting-group {
    margin-bottom: 20px;
    padding: 10px;
    border: 1px dashed #f555;
    border-radius: 5px;
}
.setting-group label {
    display: block;
    margin-bottom: 8px;
    color: #f55;
    font-size: 1.1em;
    text-align: left;
}
.settings-slider, .settings-select {
    width: 100%;
    background-color: #220000;
    border: 1px solid #444;
    color: #fff;
    padding: 5px;
    font-family: 'Courier New', Courier, monospace;
    box-sizing: border-box;
    border-radius: 3px;
}
/* Custom slider styles for spooky feel */
.settings-slider {
    -webkit-appearance: none;
    height: 10px;
    border-radius: 5px;
    background: #440000;
    outline: none;
    cursor: pointer;
}
.settings-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background: #f55;
    cursor: pointer;
}
        
/* --- ENDINGS MENU SIDEBAR --- */
#endings-sidebar {
    height: 90vh; 
    width: 300px; 
    position: fixed;
    z-index: 20; 
    top: 50%; 
    right: 0;
    background-color: rgba(17, 0, 0, 0.9); 
    overflow-x: hidden;
    transition: 0.5s;
    padding-top: 20px; 
    /* PUSH OFF-SCREEN and VERTICALLY CENTER */
    transform: translateY(-50%) translateX(100%); 
    box-shadow: -5px 0 15px rgba(255, 85, 85, 0.2); 
    border-left: 1px solid #f55; 
    display: flex;
    flex-direction: column;
}

#endings-sidebar.open {
    /* PULL BACK ON-SCREEN while maintaining vertical center */
    transform: translateY(-50%) translateX(0); 
}

#endings-list-content {
    padding: 0 15px 15px 15px;
    overflow-y: auto;
    flex-grow: 1; 
}

        #endings-sidebar h3 {
            color: #f55; 
            text-align: center;
            margin-top: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f55; 
            text-transform: uppercase;
            font-size: 1.2em;
        }

        .ending-item {
            padding: 8px 0;
            border-bottom: 1px dotted #444; 
            color: #666; 
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
            line-height: 1.2;
        }

        .ending-item.unlocked {
            color: #aaa; 
            font-weight: bold;
        }

        .ending-item .status {
            color: #ff0000; 
            margin-left: 10px;
            min-width: 10px; 
        }
        
        .ending-item.unlocked .status {
            color: #44ff44; 
        }
        
        .ending-name {
            flex-grow: 1; 
        }
        
        .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
            cursor: pointer;
            color: #f55; 
            text-decoration: none;
            line-height: 60px;
        }

        /* Adjustment to push main content when sidebar is open */
        body.sidebar-open .container {
            margin-right: 300px; 
        }

@media (max-width: 768px) {
    .container {
        width: 90vw; 
        height: 90vw; 
        max-width: none; 
    }
    /* NEW: Use 90% width on smaller screens */
    #endings-sidebar {
        width: 90%;
    }
    /* Adjust content spacing for smaller screens */
    #story-text {
        min-height: 150px; 
    }
}

/* --- Custom Scrollbar Styling for Aesthetics --- */
/* Targetting the element with isolated scrolling */
#endings-list-content::-webkit-scrollbar {
    width: 8px;
    background-color: #111; 
}

#endings-list-content::-webkit-scrollbar-thumb {
    background-color: #f55; 
    border-radius: 4px;
    border: 1px solid #330000; 
}

#endings-list-content::-webkit-scrollbar-thumb:hover {
    background-color: #fff; 
}
    </style>
</head>
<body>
    
    <audio id="rainAmbiance" loop src="rain sfx.mp3"></audio>
    
    <div id="camera-overlay"></div> 
    <div id="rain-overlay"></div> 
    <div id="blink-overlay"></div> 

    <div id="eye-container"></div> 
    
    <div id="endings-sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="toggleEndingsMenu()">&times;</a>
        <h3>Endings Tracker</h3>
        <div id="endings-list-content">
            </div>
    </div>
    
    <div class="container" id="gameContainer">
        
        <div id="start-screen" class="screen active">
            <h1 id="start-title">The Silent Corridor</h1>
            <button id="start-button" class="choice-btn">BEGIN NIGHTMARE</button>
            
            <button id="settings-button" class="choice-btn">SETTINGS</button> 
            
            <button id="endings-button" class="choice-btn" onclick="toggleEndingsMenu()">ENDINGS</button>
        </div>

        <div id="settings-screen" class="screen">
            <h1>Game Settings</h1>
            
            <div class="setting-group">
                <label for="graphics-quality">Graphics Quality:</label>
                <select id="graphics-quality" class="settings-select">
                    <option value="low">Low (Standard)</option>
                    <option value="better">Better (Camera Overlay & Rain & Eyes)</option>
                </select>
                <p style="font-size: 0.8em; margin-top: 5px; color: #777;">Better quality adds a static camera filter, a subtle rain effect, and **10 tracking eyes** for atmosphere.</p>
            </div>

            <div class="setting-group">
                <label for="flashlight-intensity">Flashlight Intensity (<span id="flashlight-value">300</span>px):</label>
                <input type="range" id="flashlight-intensity" class="settings-slider" min="100" max="300" step="10">
                <p style="font-size: 0.8em; margin-top: 5px; color: #777;">Adjusts the radius of the light cone (100px - 300px).</p>
            </div>
            
            <div class="setting-group">
                <label for="blinking-effect">Player Blinking (10-20s interval):</label>
                <select id="blinking-effect" class="settings-select">
                    <option value="on">On (Default)</option>
                    <option value="off">Off</option>
                </select>
                <p style="font-size: 0.8em; margin-top: 5px; color: #777;">Simulates the player's eyes blinking at random intervals.</p>
            </div>

            <button id="settings-save-button" class="choice-btn" style="margin-top: 20px;">SAVE & RETURN</button>
        </div>
        
        <div id="game-screen" class="screen">
            <h1 id="game-title">The Silent Corridor</h1>
            <div id="story-text">
                </div>
            <div id="choices">
                </div>
        </div>
    </div>
    <script>
        // --- Game Logic and State Management ---
        const storyTextEl = document.getElementById('story-text');
        const choicesEl = document.getElementById('choices');
        const gameContainerEl = document.getElementById('gameContainer');
        // NEW: Game Title reference
        const gameTitleEl = document.getElementById('game-title');

        const startScreenEl = document.getElementById('start-screen');
        const gameScreenEl = document = document.getElementById('game-screen');
        const startButtonEl = document.getElementById('start-button'); 

        const sidebarEl = document.getElementById('endings-sidebar');
        const listContentEl = document.getElementById('endings-list-content');
        
        // Settings elements
        const settingsScreenEl = document.getElementById('settings-screen');
        const settingsButtonEl = document.getElementById('settings-button');
        const settingsSaveButtonEl = document.getElementById('settings-save-button');
        const cameraOverlayEl = document.getElementById('camera-overlay');
        const rainOverlayEl = document.getElementById('rain-overlay'); 
        const flashlightSliderEl = document.getElementById('flashlight-intensity');
        const flashlightValueEl = document.getElementById('flashlight-value');
        const graphicsSelectEl = document.getElementById('graphics-quality');
        
        // Blink Overlay and Select Element
        const blinkOverlayEl = document.getElementById('blink-overlay'); 
        const blinkingSelectEl = document.getElementById('blinking-effect');
        
        // Eye container element
        const eyeContainerEl = document.getElementById('eye-container'); 

        // Audio element
        const rainAmbiance = document.getElementById('rainAmbiance');
        

        // Settings Logic & State Management
        const SETTINGS_KEY = 'silentCorridorSettings';
        const defaultSettings = {
            graphics: 'low',
            flashlightIntensity: 300,
            blinkingEffect: 'on' // NEW: Replaced glitchEffect
        };
        let gameSettings = {};
        
        // Tracking the previous setting for eye position persistence logic
        let previousGraphicsSetting = 'low'; 
        
        // FIX: Global variable to track the clearEyes timeout
        let clearEyesTimeout = null; 
        
        // Global variable for blinking timer
        let blinkingTimer = null; 

        // Function to load and apply settings
        function loadAndApplySettings() {
            try {
                const storedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY));
                gameSettings = storedSettings ? { ...defaultSettings, ...storedSettings } : defaultSettings;
                
                // Compatibility for old settings format (if user had old version)
                if (storedSettings && storedSettings.glitchEffect !== undefined) {
                    gameSettings.blinkingEffect = storedSettings.glitchEffect;
                    delete gameSettings.glitchEffect;
                }
            } catch (e) {
                console.error("Error loading settings from localStorage:", e);
                gameSettings = defaultSettings;
            }
            // Initialize previous setting tracker on load
            previousGraphicsSetting = gameSettings.graphics; 
            applySettings();
        }

        // Function to apply settings to the DOM/CSS
        function applySettings() {
            // 1. Flashlight Intensity
            document.body.style.setProperty('--flashlight-size', `${gameSettings.flashlightIntensity}px`);

            // 2. Graphics Quality (Camera Overlay, Rain, Eyes, and Body Distortion)
            const currentGraphics = gameSettings.graphics;

            if (currentGraphics === 'better') {
                cameraOverlayEl.classList.add('active');
                rainOverlayEl.style.opacity = '0.2'; 
                document.body.classList.add('better-graphics-active'); 
                
                // If we are *toggling* from low to better, reset positions for a fresh start.
                if (previousGraphicsSetting === 'low') {
                     eyePositions = []; 
                }
                renderEyes(); 
            } else { // currentGraphics === 'low'
                cameraOverlayEl.classList.remove('active');
                rainOverlayEl.style.opacity = '0'; 
                document.body.classList.remove('better-graphics-active'); 
                
                clearEyes(); 
                
                // When we turn off better graphics, we clear the positions.
                // This ensures the next time 'better' is selected, new positions are generated.
                eyePositions = []; 
            }
            
            previousGraphicsSetting = currentGraphics; // Update tracking variable

            // 3. Blinking Effect (Ensure state is correct if already in-game)
            if (gameScreenEl.classList.contains('active')) {
                if (gameSettings.blinkingEffect === 'on') {
                    startBlinkingTimer();
                } else {
                    stopBlinking();
                }
            }
        }
        
        // Function to render the settings UI based on current settings
        function renderSettings() {
            flashlightSliderEl.value = gameSettings.flashlightIntensity;
            flashlightValueEl.textContent = gameSettings.flashlightIntensity;
            graphicsSelectEl.value = gameSettings.graphics;
            blinkingSelectEl.value = gameSettings.blinkingEffect; // UPDATED to blinkingEffect
            
            // Live update for flashlight slider display and CSS variable for live preview
            flashlightSliderEl.oninput = function() {
                flashlightValueEl.textContent = this.value;
                document.body.style.setProperty('--flashlight-size', `${this.value}px`);
            };

            // Live update for graphics quality on change
            graphicsSelectEl.onchange = function() {
                // Temporarily update and apply the setting for live preview
                if (this.value === 'better') {
                    cameraOverlayEl.classList.add('active');
                    rainOverlayEl.style.opacity = '0.2'; 
                    document.body.classList.add('better-graphics-active');
                    // Force a new position for the preview
                    eyePositions = []; 
                    renderEyes(); 
                } else {
                    cameraOverlayEl.classList.remove('active');
                    rainOverlayEl.style.opacity = '0';
                    document.body.classList.remove('better-graphics-active');
                    clearEyes();
                    // Don't reset eyePositions here, as it will be reset in saveSettings if the user saves "low".
                }
            };
        }
        
        // Function to save settings and return
        function saveSettings() {
            // 1. Store the previous setting before updating
            const oldGraphics = gameSettings.graphics;
            
            // 2. Update gameSettings object
            gameSettings.flashlightIntensity = parseInt(flashlightSliderEl.value);
            gameSettings.graphics = graphicsSelectEl.value;
            gameSettings.blinkingEffect = blinkingSelectEl.value; // UPDATED to blinkingEffect
            
            // 3. Save to storage
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(gameSettings));
            } catch (e) {
                console.error("Error saving settings to localStorage:", e);
            }

            // 4. If graphics changed *while in settings*, the live preview cleared the eyes.
            // We need to re-apply settings fully to ensure the final state is correct.
            applySettings();

            // 5. Return to Start Screen
            toggleSettingsMenu();
        }

        // Function to toggle the settings screen visibility
        function toggleSettingsMenu() {
            if (settingsScreenEl.classList.contains('active')) {
                // Hiding settings screen, show start screen
                // IMPORTANT: Restore flashlight slider preview to saved value before returning
                document.body.style.setProperty('--flashlight-size', `${gameSettings.flashlightIntensity}px`); 
                
                // If graphics are still "better" on exit, ensure eyes are visible (they might have been hidden by a live setting change)
                if(gameSettings.graphics === 'better' && eyeContainerEl.style.opacity === '0') {
                     // Ensure the eyes are visible and tracking immediately on exit
                     eyeContainerEl.style.opacity = '1'; 
                }
                
                settingsScreenEl.classList.remove('active');
                startScreenEl.classList.add('active');
            } else {
                // Showing settings screen, hide start screen
                startScreenEl.classList.remove('active');
                renderSettings(); // Ensure UI reflects current settings
                settingsScreenEl.classList.add('active');
            }
        }

        // --- Eye Tracking Logic ---
        const EYE_COUNT = 10;
        const EYE_SIZE = 45; // Width of the new oval eye
        const EYE_HEIGHT = 35; // Height of the new oval eye
        const MIN_DISTANCE = 75; // Minimum distance between centers in pixels
        const MAX_PUPIL_MOVE = 6; 
        
        let eyePositions = []; // Global storage for persistent positions

        function generateEyePositions() {
            const positions = [];
            // Use 90% of screen size to keep eyes away from edges
            const containerWidth = window.innerWidth * 0.9;
            const containerHeight = window.innerHeight * 0.9;
            const offsetX = window.innerWidth * 0.05;
            const offsetY = window.innerHeight * 0.05;

            for (let i = 0; i < EYE_COUNT; i++) {
                let newX, newY, attempts = 0;
                let isOverlapping = true;

                while (isOverlapping && attempts < 100) {
                    // Generate random position within the 90% bounds
                    newX = Math.random() * containerWidth + offsetX;
                    newY = Math.random() * containerHeight + offsetY;
                    
                    isOverlapping = false;
                    
                    // Check against existing positions
                    for (const pos of positions) {
                        // Calculate distance between centers (Pythagorean theorem)
                        const distance = Math.sqrt(Math.pow(newX - pos.x, 2) + Math.pow(newY - pos.y, 2));
                        
                        if (distance < MIN_DISTANCE) {
                            isOverlapping = true;
                            break;
                        }
                    }
                    attempts++;
                }

                if (!isOverlapping) {
                    positions.push({ x: newX, y: newY });
                }
            }
            return positions;
        }
        
        function ensureEyePositions() {
            // Only generate new positions if the global array is empty
            if (eyePositions.length === 0) {
                eyePositions = generateEyePositions();
            }
        }

        function renderEyes() {
            if (gameSettings.graphics !== 'better') return;

            // 1. Check if positions were empty before trying to ensure them.
            const wasEmpty = eyePositions.length === 0;
            ensureEyePositions(); 
            
            // 2. Only draw the HTML if we are forced to (wasEmpty) or if the container is currently empty.
            if (wasEmpty || eyeContainerEl.innerHTML === '') {
                
                // FIX: If we are redrawing from scratch, clear any pending timeouts
                if (wasEmpty && clearEyesTimeout) {
                    clearTimeout(clearEyesTimeout);
                    clearEyesTimeout = null;
                }
                
                // Always clear the container synchronously before redrawing to prevent race conditions
                eyeContainerEl.innerHTML = ''; 
                
                eyePositions.forEach(pos => {
                    const eye = document.createElement('div');
                    eye.classList.add('eye');
                    // Set position based on center coordinates
                    eye.style.left = `${pos.x}px`;
                    eye.style.top = `${pos.y}px`;
                    // Center the eye div on the calculated position
                    eye.style.transform = `translate(-${EYE_SIZE/2}px, -${EYE_HEIGHT/2}px)`; 
                    
                    const pupil = document.createElement('span');
                    pupil.classList.add('eye-pupil');
                    eye.appendChild(pupil);
                    
                    eyeContainerEl.appendChild(eye);
                });
            }
            
            // FADE IN (transition handled by CSS)
            // Use a short delay to ensure rendering is complete before setting opacity
            setTimeout(() => {
                eyeContainerEl.style.opacity = '1';
            }, 50);
        }


        function clearEyes() {
            // FIX: Clear any existing timeout before starting a new one
            if (clearEyesTimeout) {
                clearTimeout(clearEyesTimeout);
                clearEyesTimeout = null;
            }

            // FADE OUT (transition handled by CSS)
            eyeContainerEl.style.opacity = '0';
            
            // Wait for the fade to complete before clearing innerHTML
            clearEyesTimeout = setTimeout(() => {
                eyeContainerEl.innerHTML = '';
                clearEyesTimeout = null; // Reset the tracker
            }, 1000); // Must match the CSS transition time (1.0s)
        }

        function trackEyes(mouseX, mouseY) {
            const eyes = document.querySelectorAll('.eye');
            
            eyes.forEach(eye => {
                const rect = eye.getBoundingClientRect();
                // Eye center coordinates
                const eyeX = rect.left + rect.width / 2;
                const eyeY = rect.top + rect.height / 2;

                // Vector from eye center to mouse position
                const dx = mouseX - eyeX;
                const dy = mouseY - eyeY;

                // Angle calculation
                const angle = Math.atan2(dy, dx);

                // Clamp movement distance to MAX_PUPIL_MOVE
                const distance = Math.min(MAX_PUPIL_MOVE, Math.sqrt(dx * dx + dy * dy));

                // New pupil position relative to the eye center
                const pupilX = Math.cos(angle) * distance;
                const pupilY = Math.sin(angle) * distance;

                // Apply transformation: keep it centered (-50%, -50%) then translate to tracking position
                const pupil = eye.querySelector('.eye-pupil');
                pupil.style.transform = `translate(-50%, -50%) translate(${pupilX}px, ${pupilY}px)`;
            });
        }
        
        // --- Blinking Logic (Replaces Glitch Logic) ---

        function playerBlink() {
            blinkOverlayEl.classList.add('is-blinking');
            
            // Remove the class after the animation is complete (0.15s)
            setTimeout(() => {
                blinkOverlayEl.classList.remove('is-blinking');
            }, 150);
        }

        function startBlinkingTimer() {
            // Clear any existing timer
            if (blinkingTimer) {
                clearTimeout(blinkingTimer);
                blinkingTimer = null;
            }
            
            if (gameSettings.blinkingEffect === 'off') {
                return;
            }
            
            // Random delay between 10 to 20 seconds (10000ms to 20000ms)
            const randomDelay = Math.random() * 10000 + 10000; 

            blinkingTimer = setTimeout(() => {
                playerBlink();
                // Set the timer again for the next blink
                startBlinkingTimer(); 
            }, randomDelay);
        }

        function stopBlinking() {
            if (blinkingTimer) {
                clearTimeout(blinkingTimer);
                blinkingTimer = null;
            }
            blinkOverlayEl.classList.remove('is-blinking'); // Ensure no active blink
        }


        // CRITICAL MODIFICATION: Duration for the in-game content transition fade (1.5 seconds)
        const STORY_TRANSITION_DURATION_MS = 1500;
        let TOTAL_ENDINGS = 0;
        const STORAGE_KEY = 'silentCorridorEndings';
        let gameState = {};
        
        // CRITICAL FIX: Re-inserting the full, original story nodes and endings (1-42+)
        window.storyNodes = {
            start: {
                text: "You wake up in a cold sweat. The digital clock on your nightstand flickers '3:07 AM'. A strange, crushing silence hangs in the air, a silence deeper than the usual quiet of the night. It feels like the sound has been pulled out of the world, leaving a vibrating vacuum in its place. You feel an intense, primal need to move, to check the unsettling quiet and confirm your sanity.",
                choices: [
                    { text: "Hide under the covers.", nextNode: "go_back_to_bed" },
                    { text: "Venture into the corridor.", nextNode: "corridor_start" },
                    { text: "Go to the study to look for your phone.", nextNode: "study_start" }
                ]
            },
            title_screen: { // Placeholder node
                text: "Returning to the main menu...",
                choices: [],
                isTitle: true
            },
            
            // --- Core Story Path (Room Nodes) ---
            
            go_back_to_bed: {
                text: "You pull the thick blanket over your head and squeeze your eyes shut. The silence seems to press down on the blankets, trying to get in. You feel the presence of something large and cold just outside the fabric. You can't hold your breath forever.",
                choices: [
                    { text: "Take a deep breath and stay put.", nextNode: "death_suffocation_32" },
                    { text: "Quickly dart out of bed into the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            corridor_start: {
                text: "The corridor is a long, dark tunnel stretching into the void. The moonlight that should be streaming through the windows is blocked by a thick, oppressive blackness. The floorboards are too cold, and you realize the rain outside is completely inaudible. The silence is absolute, heavy, and metallic. Ahead, you can make out the outlines of the living room, the kitchen entrance, and the bathroom door.",
                choices: [
                    { text: "Enter the living room.", nextNode: "living_room_start" },
                    { text: "Go towards the kitchen.", nextNode: "kitchen_start" },
                    { text: "Check the bathroom.", nextNode: "bathroom_start" }
                ]
            },

            study_start: {
                text: "The study is a small, cramped room lined with bookshelves and a heavy mahogany desk. It smells of dust and old paper. The lack of light makes finding anything impossible. You fumble for the phone on the desk.",
                choices: [
                    { text: "Search the desk drawers.", nextNode: "study_desk_search" },
                    { text: "Check the bookshelf.", nextNode: "study_bookshelf" },
                    { text: "Leave and enter the corridor.", nextNode: "corridor_start" }
                ]
            },

            // --- Study Path ---

            study_desk_search: {
                text: "The top drawer is empty. The second drawer holds a small, leather-bound journal. The third drawer is stuck.",
                choices: [
                    { text: "Open the journal.", nextNode: "study_journal" },
                    { text: "Force the third drawer open.", nextNode: "study_drawer_force" }
                ]
            },

            study_journal: {
                text: "The journal is filled with tight, panicked handwriting. The last entry reads: 'The only way out is through the **chimney**â€”or to **reverse the order** of the seven marks.' A small, crudely drawn sketch is taped to the page, showing seven tally marks.",
                choices: [
                    { text: "Attempt to climb the chimney now (requires being near the fireplace).", nextNode: "corridor_start" }, // Back to corridor, must find fireplace
                    { text: "Memorize the seven marks and close the journal.", nextNode: "study_journal_memorize" }
                ]
            },
            
            study_journal_memorize: {
                text: "You tuck the knowledge away. The number seven, the chimney, and the need for reversal. What reversal?",
                choices: [
                    { text: "Go to the bookshelf.", nextNode: "study_bookshelf" },
                    { text: "Go to the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            study_drawer_force: {
                text: "You heave against the drawer. With a loud, splintering crack, it gives way. Inside is a small, silver key and a faint, high-pitched **humming** sound coming from behind the wall paneling.",
                choices: [
                    { text: "Take the key and investigate the humming.", nextNode: "study_hidden_panel" },
                    { text: "Take the key and return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            study_hidden_panel: {
                text: "You follow the humming. It leads to a section of the wall behind the bookshelf. A hidden panel is revealed, behind which sits a large, black machine humming silently. It has a single, large **red button** labeled 'DISPERSE'.",
                choices: [
                    { text: "Press the red button.", nextNode: "death_failed_teleport_53" },
                    { text: "Leave the machine alone.", nextNode: "corridor_start" }
                ]
            },

            study_bookshelf: {
                text: "The books are all dusty and uninteresting, except for one bound in heavy brass, titled 'The Compendium of Lost Sounds.' The books behind it seem slightly misaligned.",
                choices: [
                    { text: "Pull the brass-bound book.", nextNode: "ending_the_composer_43" },
                    { text: "Investigate the misaligned books.", nextNode: "study_bookshelf_2" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            study_bookshelf_2: {
                text: "The books are a false front. Behind them is a small, perfectly preserved **birdcage** containing a **single, black, flightless bird** that stares at you with a silent, malevolent gaze. It does not move.",
                choices: [
                    { text: "Open the cage and release the bird.", nextNode: "death_bird_release_44" },
                    { text: "Slam the false front shut and leave.", nextNode: "corridor_start" }
                ]
            },
            
            // --- Corridor/Corridor Loop Path ---
            
            corridor_loop_1: {
                text: "You walk for what feels like hours. Every door you pass leads back to your bedroom, which is now empty, the bed unmade. You realize the house is warping space around you. You are back in the main corridor, but it feels different.",
                choices: [
                    { text: "Go back to the living room.", nextNode: "living_room_start" },
                    { text: "Go back to the kitchen.", nextNode: "kitchen_start" },
                    { text: "Check the bathroom.", nextNode: "bathroom_start" }
                ]
            },
            
            corridor_wait: {
                text: "You decide to wait it out. The silence is a physical weight, pressing against your eardrums. You wait. And wait. The clock in your mind ticks past 4:00 AM, 5:00 AM... you are still waiting.",
                choices: [
                    { text: "Stay here until dawn (risky).", nextNode: "ending_27" },
                    { text: "Start tapping your feet rhythmically.", nextNode: "ending_28" }
                ]
            },

            // --- Living Room Path ---
            
            living_room_start: {
                text: "The living room is dominated by a large, empty stone **fireplace** and a black, static-filled **television** screen. An old, worn **armchair** sits in the middle of the room, near the fireplace. A large picture **window** faces the street.",
                choices: [
                    { text: "Investigate the fireplace.", nextNode: "living_room_fireplace" },
                    { text: "Look out the window.", nextNode: "living_room_window" },
                    { text: "Check the armchair.", nextNode: "living_room_armchair" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            living_room_fireplace: {
                text: "The fireplace is cold and smells of burnt wood. A small, rusty **chimney sweep** tool leans against the hearth.",
                choices: [
                    { text: "Attempt to climb the chimney (risk of getting stuck).", nextNode: "ending_chimney" },
                    { text: "Use the chimney sweep to poke the ashes.", nextNode: "living_room_fireplace_poke" }
                ]
            },

            living_room_fireplace_poke: {
                text: "You stir the ashes. Hidden beneath them is a small, smooth **white stone** and a tiny, almost invisible **switch** on the inside wall of the hearth.",
                choices: [
                    { text: "Take the white stone.", nextNode: "living_room_fireplace_stone" },
                    { text: "Flip the switch.", nextNode: "ending_26" }
                ]
            },
            
            living_room_fireplace_stone: {
                text: "You pocket the stone. It's oddly warm and vibrates slightly. You leave the switch alone for now.",
                choices: [
                    { text: "Look out the window.", nextNode: "living_room_window" },
                    { text: "Go to the armchair.", nextNode: "living_room_armchair" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            living_room_window: {
                text: "You peer out the window. It is raining heavily, but the rain makes no sound. Across the street, you see a faint **figure** standing perfectly still, watching the house. It is too dark to make out features.",
                choices: [
                    { text: "Stare intently at the figure.", nextNode: "ending_listen_still" },
                    { text: "Try to make a noise to get the figure's attention.", nextNode: "living_room_window_noise" }
                ]
            },
            
            living_room_window_noise: {
                text: "You can't shout, but you can tap the window glass. The sound is a dull, muffled thud, yet the figure across the street raises a hand and slowly points, not at you, but at the **television**.",
                choices: [
                    { text: "Check the television.", nextNode: "living_room_tv" },
                    { text: "Ignore the figure and return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            living_room_armchair: {
                text: "The armchair is deep and uncomfortable. As you lean over it, you see a single strand of impossibly long, black **hair** draped over the back.",
                choices: [
                    { text: "Sit in the armchair.", nextNode: "death_crushing_33" },
                    { text: "Examine the hair closer.", nextNode: "death_hair" }
                ]
            },
            
            living_room_tv: {
                text: "The old TV screen is black, glowing with static. The only 'sound' it emits is a high-pitched, silent **whine** that makes your teeth ache.",
                choices: [
                    { text: "Touch the screen.", nextNode: "death_tv_touch" },
                    { text: "Tap the TV screen like a code.", nextNode: "ending_14" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },

            // --- Kitchen Path ---
            
            kitchen_start: {
                text: "The kitchen is a picture of domestic horror. The air is freezing, and on the floor, in front of the large, industrial-looking **freezer**, is a crudely painted, red **symbol**. A half-empty **milk bottle** sits on the counter.",
                choices: [
                    { text: "Investigate the red symbol.", nextNode: "kitchen_symbol" },
                    { text: "Check the freezer.", nextNode: "kitchen_freezer" },
                    { text: "Grab the milk bottle.", nextNode: "kitchen_milk_bottle" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },

            kitchen_symbol: {
                text: "The red symbol pulses faintly. It feels cold and slightly wet to the touch. You get the overwhelming feeling that if you step on it, the house wins.",
                choices: [
                    { text: "Try to wipe the symbol away.", nextNode: "death_wipe_symbol" },
                    { text: "Deliberately step on the symbol.", nextNode: "ending_15" },
                    { text: "Look around the rest of the kitchen.", nextNode: "kitchen_start" }
                ]
            },

            kitchen_freezer: {
                text: "The freezer is a monstrosity, humming a silent, deep tone. It is completely full of frozen food, mostly bags of peas and various vegetables. It has a large **crisper** drawer at the bottom.",
                choices: [
                    { text: "Open the crisper drawer.", nextNode: "death_crisper" },
                    { text: "Try to organize the frozen vegetables.", nextNode: "ending_21" },
                    { text: "Check behind the freezer (hard to reach).", nextNode: "kitchen_behind_freezer" }
                ]
            },
            
            kitchen_behind_freezer: {
                text: "You manage to squeeze behind the freezer. You find a loose piece of **chalk** and a small section of the wall where the word 'OUT' is scrawled.",
                choices: [
                    { text: "Take the chalk and return to the corridor.", nextNode: "corridor_start" },
                    { text: "Use the chalk to draw a sketch of the house.", nextNode: "ending_20" }
                ]
            },

            kitchen_milk_bottle: {
                text: "The milk bottle is thick glass, about half full. It is the only object in the house that seems like a potential projectile.",
                choices: [
                    { text: "Drink the milk (it might be poisoned).", nextNode: "death_milk_39" },
                    { text: "Smash the bottle against the red symbol.", nextNode: "ending_symbol_erased" },
                    { text: "Smash the bottle against the window.", nextNode: "death_window_smash_40" }
                ]
            },

            // --- Bathroom Path ---

            bathroom_start: {
                text: "The bathroom is warm and humid. The mirror is completely **fogged**. The **sink** contains a thick, black, oil-like liquid that does not move, and the **medicine cabinet** is slightly ajar.",
                choices: [
                    { text: "Wipe the mirror.", nextNode: "bathroom_mirror_wipe" },
                    { text: "Examine the oil in the sink.", nextNode: "bathroom_sink_oil" },
                    { text: "Open the medicine cabinet.", nextNode: "bathroom_cabinet" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },

            bathroom_mirror_wipe: {
                text: "You wipe a circle on the mirror. Your reflection stares back, but it is **grotesque**â€”mouth wide open, eyes black. It is silent, but you can feel its despair.",
                choices: [
                    { text: "Stare back into the reflection.", nextNode: "death_mirror" },
                    { text: "Quickly draw a happy face on the fog.", nextNode: "ending_13" },
                    { text: "Smash the mirror (dangerous).", nextNode: "death_mirror_smash_45" }
                ]
            },

            bathroom_sink_oil: {
                text: "The thick, black oil smells faintly of earth and metal. It looks like it could be a map or a hidden message.",
                choices: [
                    { text: "Collect a sample of the oil.", nextNode: "ending_oil_discovery" },
                    { text: "Spread the oil on the floor like a map.", nextNode: "ending_24" },
                    { text: "Wash your hands in the oil.", nextNode: "death_oil_poison_46" }
                ]
            },

            bathroom_cabinet: {
                text: "The medicine cabinet is filled with nothing but dust and cobwebs, except for a single, empty **pill bottle** that rattles faintly.",
                choices: [
                    { text: "Shake the pill bottle (it rattles).", nextNode: "death_rattle_47" },
                    { text: "Search behind the cabinet mirror.", nextNode: "bathroom_cabinet_behind" }
                ]
            },
            
            bathroom_cabinet_behind: {
                text: "Behind the cabinet is a small, hollow space. Inside, you find a small, tarnished silver **bell** and a message scrawled on the back wall: 'RING ONCE.'",
                choices: [
                    { text: "Ring the bell once.", nextNode: "ending_silence_broken" },
                    { text: "Ring the bell multiple times (too risky).", nextNode: "death_bell_many_48" }
                ]
            },

            // --- Alternative Paths & Items ---
            
            // This is a placeholder for a hidden area, e.g., using the key from the study.
            hidden_area_1: {
                text: "The silver key from the study unlocks a small door in the back of the linen closet. It opens to a steep, dark **stairwell** leading down. You hear the faint, silent humming again.",
                choices: [
                    { text: "Descend the stairs to the basement.", nextNode: "basement_start" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            // --- Basement Path ---
            
            basement_start: {
                text: "The basement is a large, unfinished space with a dirt floor. The silent humming is much louder here. It emanates from a large, complex, metallic **mechanism** in the center of the room. A **breaker box** is on the far wall.",
                choices: [
                    { text: "Investigate the metallic mechanism.", nextNode: "basement_mechanism" },
                    { text: "Check the breaker box.", nextNode: "basement_breaker_box" },
                    { text: "Try to find another way out (e.g., a window).", nextNode: "death_window_climb" }
                ]
            },
            
            basement_mechanism: {
                text: "The mechanism is intricate, with dozens of turning brass gears. It seems to be the source of the house's silent energy, absorbing all sound. You see a set of large **brass teeth** rotating slowly.",
                choices: [
                    { text: "Stick your hand into the gears to stop it.", nextNode: "death_mechanism_hand_52" },
                    { text: "Try to break the mechanism with the white stone.", nextNode: "ending_stone_break_51" },
                    { text: "Go to the breaker box.", nextNode: "basement_breaker_box" }
                ]
            },
            
            basement_breaker_box: {
                text: "The breaker box is a massive panel with fifty-four individual switches. One switch is much larger than the rest, labeled **'MAIN'**.",
                choices: [
                    { text: "Flip the MAIN breaker.", nextNode: "death_static_void_54" },
                    { text: "Flip a random smaller breaker (risky).", nextNode: "death_breaker_random_50" },
                    { text: "Leave the box alone.", nextNode: "basement_start" }
                ]
            },
            
            // --- Complex Endings/Deaths (Requires multiple steps or items) ---
            
            // ... (Add complex narrative nodes if necessary, then follow with final ending nodes) ...
            
            // Example of a longer path using prior knowledge
            living_room_armchair_pull: {
                text: "You pull the armchair away from the wall. Behind it is a large, steel **hatch** with a small dial lock.",
                choices: [
                    { text: "Try to open the hatch (requires key or code).", nextNode: "living_room_armchair_hatch" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            living_room_armchair_hatch: {
                text: "The lock requires a four-digit code. You have no idea what it is.",
                choices: [
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            // --- Final Escape/Resolution Nodes (Placeholder until next stage) ---
            
            garden_hedge: {
                text: "You find a weak spot in the garden hedge. It's a large, thorny bush, but it feels less substantial than the walls of the house. You can force your way through the wall, emerging safely in the small garden. The hole in the hedge seals instantly behind you.",
                choices: [
                    { text: "Investigate the shed.", nextNode: "garden_shed_2" }
                ]
            },
            
            // --- Endings (54 Total) ---
            
            // Endings 1-30
            ending_1: {
                text: "You wake up again, sweat-soaked, the digital clock flickering '3:07 AM'. But this time, you hear the distant, gentle sound of rain outside. The silence is gone. You are safe, for now.",
                endingTitle: "ENDING 1/54: Reawakening",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 1
            },
            ending_chimney: {
                text: "You scramble up the chimney, driven by the journal's cryptic promise. It is a long, dark, suffocating climb. You scrape your hands and face on the brickwork. Just as you feel you can't breathe, you burst out onto the roof, coughing. The air is clear, the rain is audible, and in the distance, you hear sirens. The house is silent behind you, and you leave it there.",
                endingTitle: "ENDING 2/54: The Exit",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 2
            },
            ending_3: {
                text: "The silence breaks not with a sound, but with a color. A brilliant, sapphire blue overwhelms your vision. When it fades, you are standing outside, on a clear, sunny morning. You have no memory of the house.",
                endingTitle: "ENDING 3/54: The Reset",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 3
            },
            ending_safe_in_corridor: {
                text: "You stand guard in the middle of the corridor, flashlight beam steady. You stay there until dawn, fighting the urge to move. The silence breaks at 6:00 AM with the sound of a distant, ringing phone. You are safe, for now.",
                endingTitle: "ENDING 4/54: Stasis",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 4
            },
            ending_silence_broken: {
                text: "You manage to make a small, audible soundâ€”a cough, a whispered word. The silence recoils, shattering like glass. The house fills with the sound of rushing wind and normal ambiance. You are momentarily deafened, but you stumble out the front door and find yourself on a quiet street. The sound is back.",
                endingTitle: "ENDING 5/54: Shattered",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 5
            },
            ending_stay_still: {
                text: "You force yourself to remain perfectly still in the middle of the corridor, not moving a muscle, not making a sound. The silence accepts your obedience. When dawn breaks, the house has returned to normal. You simply walk out. The night passes without incident.",
                endingTitle: "ENDING 6/54: Sanity",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 6
            },
            ending_oil_discovery: {
                text: "You realize the black fluid is not just oil or blood, but crude, undiluted petroleum. You bottle a sample, leave the bathroom, and escape the house without incident, realizing the property holds a major industrial secret.",
                endingTitle: "ENDING 7/54: The Black Gold",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 7
            },
            ending_listen_still: {
                text: "You listen intently. The figure across the street raises a hand and slowly waves. It's a neighbor, confused by your flashlight beam. The silence was just the isolation of the rain and darkness. You go back to bed, embarrassed.",
                endingTitle: "ENDING 8/54: The Misunderstanding",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 8
            },
            ending_nothing_there: {
                text: "You listen intently. The silence is still there, but you realize it's completely empty, like a husk. The silence is complete, and you find that you can think clearly now, without fear. You walk out the front door, untouched.",
                endingTitle: "ENDING 9/54: Solitude",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 9
            },
            ending_symbol_erased: {
                text: "The crash from the milk bottle breaking against the freezer door is deafening, a shockwave of sound that temporarily breaks the silence. The red symbol is scratched and damaged, and the door is dented. The symbol begins to fade slowly, and by dawn, it is gone, along with the oppressive feeling in the kitchen.",
                endingTitle: "ENDING 10/54: The Destroyer",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 10
            },
            ending_11: {
                text: "You find a hidden door in the living room wall disguised as a bookshelf. It opens to a perfectly normal hallway leading to an unalarming front door. You walk out into a clear morning.",
                endingTitle: "ENDING 11/54: The Hidden Way",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 11
            },
            ending_12: {
                text: "You find a hidden key beneath the armchair cushion. It unlocks the front door. You step outside, and the silence immediately gives way to the gentle sounds of a simple, peaceful, sunny morning.",
                endingTitle: "ENDING 12/54: The Key",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 12
            },
            ending_13: {
                text: "You use the flashlight to draw a happy face on the fogged mirror. The warper reflection laughs, but the sound is so silly it loses its power. You leave the bathroom and the house in a state of amused confusion.",
                endingTitle: "ENDING 13/54: Humor",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 13
            },
            ending_14: {
                text: "The hum of the TV is a code. You tap it out on the floor, and a hidden passage opens beneath the armchair.",
                endingTitle: "ENDING 14/54: The Code",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 14
            },
            ending_15: {
                text: "The kitchen is a portal. You deliberately step on the red symbol, and the room melts away, depositing you safely outside the house's orbit.",
                endingTitle: "ENDING 15/54: Deliberate Step",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 15
            },
            ending_16: {
                text: "The phone, though dead, emits a faint radio signal. You use it to guide yourself out, following the signal through the house's maze.",
                endingTitle: "ENDING 16/54: The Signal",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 16
            },
            ending_17: {
                text: "You remember the exact coordinates of the house from a recent map check. By concentrating on them, you realize the house is an illusion created by your mind. The corridor dissolves, and you wake up in your own bed.",
                endingTitle: "ENDING 17/54: The Map-Mind",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 17
            },
            ending_18: {
                text: "You find a hidden hatch in the bedroom floor. It leads to a storm drain, which you navigate until you emerge on a nearby street. The drain water is deafeningly loud, confirming your escape.",
                endingTitle: "ENDING 18/54: The Drain",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 18
            },
            ending_19: {
                text: "You decide to walk the perimeter of the house, touching every wall and door in a specific sequence. This act of methodical movement breaks the spatial anomaly. The front door opens to a bright morning.",
                endingTitle: "ENDING 19/54: The Map",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 19
            },
            ending_20: {
                text: "You draw a sketch of the house, including the red symbol. By externalizing the fear, you make it controllable. The front door opens.",
                endingTitle: "ENDING 20/54: Externalization",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 20
            },
            ending_21: {
                text: "You go back to the kitchen and organize all the frozen items by date. The act of imposed order breaks the anomaly's chaos. The house returns to normal.",
                endingTitle: "ENDING 21/54: Order",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 21
            },
            ending_22: {
                text: "You realize the seven tally marks on the sketch are seven sequential actions you must perform. After completing the final one, the front door reveals a beautiful meadow at dawn.",
                endingTitle: "ENDING 22/54: The Sequence",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 22
            },
            ending_23: {
                text: "You find a photograph of yourself in the study. You burn it, breaking the house's connection to your personal fear.",
                endingTitle: "ENDING 23/54: Severed Link",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 23
            },
            ending_24: {
                text: "The bathroom sink oil is a map. You spread it on the floor, and it points to a tiny pinprick of lightâ€”the front door. You follow the path and escape.",
                endingTitle: "ENDING 24/54: The Oily Map",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 24
            },
            ending_25: {
                text: "You find a hidden safe in the bedroom closet. Inside is a note: 'It was only a dream.' You wake up, and it was.",
                endingTitle: "ENDING 25/54: Only a Dream",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 25
            },
            ending_26: {
                text: "The switch in the fireplace activates a speaker system, filling the house with loud, familiar, normal sounds.",
                endingTitle: "ENDING 26/54: The Switch",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 26
            },
            ending_27: {
                text: "You decide to wait out the night in the corridor, but instead of being safe, you realize you're being hunted. You hide in a closet and only emerge when the sun rises, barely alive.",
                endingTitle: "ENDING 27/54: The Hunted",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 27
            },
            ending_28: {
                text: "You begin to tap your feet rhythmically. The silence tries to swallow the sound, but you tap faster and louder. The house becomes distracted, and you escape through the front door.",
                endingTitle: "ENDING 28/54: Distraction",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 28
            },
            ending_29: {
                text: "You sing a loud, clear song. The house, unused to sound, recoils and spits you out onto the street.",
                endingTitle: "ENDING 29/54: The Song",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 29
            },
            ending_30: {
                text: "You find a hidden hatch in the living room floor. It opens to a perfectly normal basement with a secure exit.",
                endingTitle: "ENDING 30/54: The Hatch",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 30
            },
            
            // --- Original Death/Failure Nodes (IDs 31-42) ---
            death_mirror: {
                text: "You stare back into the grotesque reflection. It leans forward, smiling, until the reflection is all you see. You don't know how long you stand there, but when your senses return, you are trapped, staring at a smiling, grotesque reflection of nothing.",
                endingDescription: "Trapped in the reflection.",
                isDeath: true,
                endingId: 31
            },
            death_suffocation_32: {
                text: "You stay put, squeezing your eyes shut. The thing outside the blanket presses harder. You eventually run out of oxygen. You open your eyes only to find yourself still under the blanket, but the world is now a permanent, silent black.",
                endingDescription: "Suffocation by silence.",
                isDeath: true,
                endingId: 32
            },
            death_crushing_33: {
                text: "You sit in the armchair. It wraps around you, hardening like concrete. The silence, which is not an absence of air but a dense, cold vacuum, slams into you, crushing your lungs and bursting your eardrums.",
                endingDescription: "Vacuum pressure.",
                isDeath: true,
                endingId: 33
            },
            death_tv_touch: {
                text: "You reach out and touch the black screen. It is scorching hot. The high-pitched whine jumps directly into your mind, shattering your concentration until all you know is the sound.",
                endingDescription: "Shattered by sound.",
                isDeath: true,
                endingId: 34
            },
            death_hair: {
                text: "You examine the hair closer. It's a single, black wire, impossibly thin. As you touch it, it wraps around your finger, then your wrist, then your arm, tightening, cutting off circulation and pulling you into the empty space behind the chair.",
                endingDescription: "Caught in the hair's grip.",
                isDeath: true,
                endingId: 35
            },
            death_window_stare: { // This node was not originally referenced, keeping for consistency.
                text: "You stare at the figure across the street, trying to see its face. It lifts its head, and the rain stops. You realize you are looking at your own reflection in a pane of glass that isn't there. You step forward, falling three stories onto the unseen street below.",
                endingDescription: "The false reflection.",
                isDeath: true,
                endingId: 36
            },
            death_crisper: {
                text: "You reach into the crisper. It is empty, except for a perfectly preserved, human-sized heart, beating once, silently, against your hand. You die of sheer terror.",
                endingDescription: "Sheer terror.",
                isDeath: true,
                endingId: 37
            },
            death_wipe_symbol: {
                text: "You try to wipe the symbol off. The red paint is corrosive. It burns through your skin, your muscle, and your bone until your hand is nothing but a charred stump.",
                endingDescription: "The corrosive symbol.",
                isDeath: true,
                endingId: 38
            },
            death_milk_39: {
                text: "You drink the milk. It is room temperature, thick, and tastes metallic. It is not milk. You feel your throat close up and your blood turn to sludge.",
                endingDescription: "Poisoned milk.",
                isDeath: true,
                endingId: 39
            },
            death_window_smash_40: {
                text: "You smash the milk bottle against the window. The sound is a dull, flat thudâ€”not the expected shattering crash. The glass does not break. The silence pushes back, forcing the glass shards deep into your flesh.",
                endingDescription: "Glass shards.",
                isDeath: true,
                endingId: 40
            },
            death_jump_41: {
                text: "You jump out the window, aiming for a nearby roof. You miss. The fall is completely silent, and the impact is a brief, painless burst of darkness.",
                endingDescription: "Silent fall.",
                isDeath: true,
                endingId: 41
            },
            death_window_climb: {
                text: "You try to climb the brick wall. A brick comes loose, then another. You slip, falling to your death on the unseen street below.",
                endingDescription: "Bricks of betrayal.",
                isDeath: true,
                endingId: 42
            },
            
            // --- NEW Endings (IDs 43-54) ---
            ending_the_composer_43: { // from study_bookshelf_2
                text: "You take the book. As your fingers brush the cover, you are overwhelmed by a thousand tiny, beautiful soundsâ€”the rustle of leaves, a child's laugh, a distant bell. You realize the house is not silent, but is *storing* all sound. By holding the Compendium, you become the house's conductor, and you conduct yourself safely out.",
                endingTitle: "ENDING 43/54: The Composer",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 43
            },
            death_bird_release_44: { // from study_bookshelf_2
                text: "You open the cage. The bird does not fly; it simply stares. Its beak opens and closes silently, and a moment later, you realize it is *sucking* the life and warmth out of you. You are left cold and still, a silent meal for the caged thing.",
                endingDescription: "A silent meal.",
                isDeath: true,
                endingId: 44
            },
            death_mirror_smash_45: { // from bathroom_mirror_wipe
                text: "You smash the mirror with your flashlight. The glass shatters, but the sound is swallowed. The grotesque reflection's face splits into a thousand shards, and each one of them reflects a terrifying, silent future for you. You are overwhelmed by the images and lose your mind.",
                endingDescription: "Thousand reflections.",
                isDeath: true,
                endingId: 45
            },
            death_oil_poison_46: { // from bathroom_sink_oil
                text: "You wash your hands in the oil. It seeps into your skin, cold and numbing. The oil is a living thing; it crawls up your arms, seeking your heart. You feel your pulse slow and fade into the silence.",
                endingDescription: "Living oil.",
                isDeath: true,
                endingId: 46
            },
            death_rattle_47: { // from bathroom_cabinet
                text: "You shake the pill bottle. The faint rattle is the only sound. The sound is so small, so isolated, that the house focuses all its silent energy on it, and then on you. You feel a massive pressure build inside your skull until it bursts.",
                endingDescription: "The fatal rattle.",
                isDeath: true,
                endingId: 47
            },
            death_bell_many_48: { // from bathroom_cabinet_behind
                text: "You ring the bell repeatedly, desperate for a loud sound. The house is enraged. A high-frequency, silent wave hits you, liquefying your internal organs without making a single noise.",
                endingDescription: "Silent liquefaction.",
                isDeath: true,
                endingId: 48
            },
            ending_reverse_marks_49: { // Placeholder for an ending requiring knowledge of the "reverse" code
                text: "You correctly perform the seven actions in reverse order. The house groans, and the walls shift back to their original position. A hidden door opens, leading to a street you recognize.",
                endingTitle: "ENDING 49/54: Reversal",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 49
            },
            death_breaker_random_50: { // from basement_breaker_box
                text: "You flip a random breaker. The basement plunges into total, physical darkness. A cold, non-spatial entity wraps around you. You are consumed by the true, empty void.",
                endingDescription: "Consumed by void.",
                isDeath: true,
                endingId: 50
            },
            ending_stone_break_51: { // from basement_mechanism
                text: "You strike the brass gears with the white stone. The stone glows brightly, and the mechanism shudders, emitting a deafeningly loud, piercing **screech**â€”the first true sound in the house. The mechanism breaks, the silence collapses, and you are spat out onto the street.",
                endingTitle: "ENDING 51/54: Screech of Freedom",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 51
            },
            death_mechanism_hand_52: { // from basement_mechanism
                text: "You stick your hand into the turning brass teeth. The machine doesn't make a sound, but your hand is ground to a pulp. The mechanism continues to spin, and the pain is a silent, searing fire in your nerves.",
                endingDescription: "Caught in the machine.",
                isDeath: true,
                endingId: 52
            },
            death_failed_teleport_53: { // from study_hidden_panel_3
                text: "You press the button. The room flashes, and you feel a wrenching force tearing at your body. When the sensation stops, you realize only your head and shoulders have made it to the next room. The rest of your body is left behind in the study.",
                endingDescription: "A partial trip.",
                isDeath: true,
                endingId: 53
            },
            death_static_void_54: { // from basement_breaker_box_4
                text: "You flip the MAIN breaker. The humming stops completely. The world turns to a silent, white static field. You are left floating in a void of pure nothingness, your senses stripped away, forever.",
                endingDescription: "Annihilated by the void.",
                isDeath: true,
                endingId: 54
            },
            
            title_screen: {
                text: "Returning to the main menu...",
                choices: [],
                isTitle: true
            }
        };


        // Function to determine the total number of *tracked* endings (nodes with isEnding: true or isDeath: true)
        function calculateTotalEndings() {
            let count = 0;
            for (const key in window.storyNodes) {
                // MODIFIED to include isDeath nodes in the total count
                if (window.storyNodes[key].isEnding === true || window.storyNodes[key].isDeath === true) {
                    count++;
                }
            }
            // TOTAL ENDINGS is now 54 (30 original + 12 old deaths + 12 new = 54)
            TOTAL_ENDINGS = count;
        }

        // Function to populate the endings list
        window.populateEndingsList = function() {
            calculateTotalEndings();
            const unlockedEndings = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            listContentEl.innerHTML = ''; // Clear old content

            const endingNodes = Object.keys(window.storyNodes)
                .map(key => ({ ...window.storyNodes[key], nodeKey: key }))
                // MODIFIED filter to include both Endings and Deaths
                .filter(node => node.isEnding || node.isDeath)
                .sort((a, b) => a.endingId - b.endingId);

            endingNodes.forEach(node => {
                const isUnlocked = unlockedEndings.includes(node.nodeKey);
                // 1. Determine the prefix (ENDING or DEATH) and the display name
                const prefix = node.isEnding ? "ENDING" : "DEATH";
                let dynamicTitle;
                
                if (node.isEnding) {
                    // Main endings replace the X/Y part (e.g., 1/30) with the dynamic endingId/TOTAL_ENDINGS (e.g., 1/54)
                    dynamicTitle = node.endingTitle.replace(/(\d+)\/(\d+)/, `${node.endingId}/${TOTAL_ENDINGS}`);
                } else {
                    // Death endings use the GAME OVER prefix, and a format like (31/54)
                    dynamicTitle = `${prefix} (${node.endingId}/${TOTAL_ENDINGS}): ${node.endingDescription}`;
                }
                
                const item = document.createElement('div');
                item.classList.add('ending-item');
                if (isUnlocked) {
                    item.classList.add('unlocked');
                }
                const statusSymbol = isUnlocked ? 'âœ“' : 'âœ—';
                
                // Split the generated dynamic title into the number/prefix part and the name part
                const parts = dynamicTitle.split(':');
                const prefixAndNumber = parts[0].trim();
                const cleanName = parts.slice(1).join(':').trim();

                item.innerHTML = `
                    <span class="ending-name">${prefixAndNumber} - ${cleanName}</span>
                    <span class="status">${statusSymbol}</span>
                `;
                listContentEl.appendChild(item);
            });

            // Add a completion status at the top of the list
            const unlockedCount = unlockedEndings.length;
            const statusHeader = document.createElement('h4');
            statusHeader.style.color = unlockedCount === TOTAL_ENDINGS ? '#44ff44' : '#f55'; /* Light red/green status */
            statusHeader.style.textAlign = 'center';
            statusHeader.style.marginTop = '20px';
            statusHeader.innerHTML = `**Status:** ${unlockedCount}/${TOTAL_ENDINGS} Found`;
            listContentEl.prepend(statusHeader);
        }

        // Function to toggle the sidebar menu
        function toggleEndingsMenu() {
            startAmbiance(); // Ensure audio starts on first click
            window.populateEndingsList();
            sidebarEl.classList.toggle('open');
            document.body.classList.toggle('sidebar-open');
        }
        window.toggleEndingsMenu = toggleEndingsMenu; // Expose to global scope for HTML onclick

        // --- Audio Management Logic ---
        
        function startAmbiance() {
            if (rainAmbiance.paused) {
                // Check if browser allows autoplay and try to start
                const playPromise = rainAmbiance.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // Autoplay started!
                    }).catch(error => {
                        // Autoplay prevented. User must interact first.
                        console.log("Autoplay prevented. Audio will start on the next user interaction.");
                    });
                }
            }
        }

        // --- Screen Management Logic ---

        // Wrapper function for clicks that should also start audio
        function handleStartScreenClick(callback) {
            startAmbiance();
            callback();
        }

        // Main function to switch screens and enable start screen fade-in
        function showScreen(screenId) {
            // FIX: Only clear lingering 'fade-out' classes from screens that rely on the transition.
            // We prevent the blanket removal of 'active' at the start, which instantly hid the menu in previous versions.
            startScreenEl.classList.remove('fade-out');
            gameScreenEl.classList.remove('fade-out');

            if (screenId === 'start') {
                stopBlinking(); // Stop blinking timer when on start screen
                gameContainerEl.classList.remove('game-over');
                
                // Hide other screens instantly
                gameScreenEl.classList.remove('active');
                settingsScreenEl.classList.remove('active');
                
                // 1. Set the opacity to 0 and make it active (display: block)
                startScreenEl.classList.add('fade-out');
                startScreenEl.classList.add('active');

                // 2. Small timeout to ensure the browser registers opacity: 0 before triggering transition
                setTimeout(() => {
                    // 3. Remove the fade-out class to transition opacity back to 1 (1.0s)
                    startScreenEl.classList.remove('fade-out');
                }, 50); // Small delay
            } else if (screenId === 'game') {
                // 1. Make the start screen fade out over 1.0s
                startScreenEl.classList.add('fade-out');

                // Close the sidebar if it's open when starting the game
                if(sidebarEl.classList.contains('open')) {
                    toggleEndingsMenu();
                }
                
                // Close settings if it's open
                settingsScreenEl.classList.remove('active');

                // The first delay allows the start screen to fully fade out (1.0s transition)
                // CORRECTION: Set time to 1000ms to match CSS and quick flow request.
                setTimeout(() => {
                    // A. Deactivate the start screen (hiding it) and start the game screen fade-in (1.0s fade)
                    startScreenEl.classList.remove('active'); // <-- ACTIVE is removed ONLY after fade is complete
                    gameScreenEl.classList.add('active'); 

                    // B. After the game screen is fully visible (1.0s), trigger the content fade (1.5s)
                    setTimeout(() => {
                        // Load and fade-in the content
                        showStoryNode('start'); 
                    }, 1000); // Delay for the container fade (1.0s)
                }, 1000); // Delay for the start screen fade (1.0s)
            }
        }

        // Manages the in-game transition fade-out and content swap.
        function handleInGameTransition(nextNode) {
            // If transitioning back to the title screen from an ending/death
            if (nextNode === 'title_screen') {
                // Apply the fade-out class to the whole game screen container (1.0s transition)
                gameScreenEl.classList.add('fade-out');
                gameTitleEl.style.opacity = '0';
                stopBlinking(); // Stop blinking on exit

                // Wait for the full game screen fade-out duration (1.0s)
                setTimeout(() => {
                    showScreen('start');
                }, 1000);
                return;
            }

            // For normal node transitions: fade out content (1.5s)
            storyTextEl.style.opacity = '0';
            choicesEl.style.opacity = '0';
            // Title opacity stays the same, though it usually stays (keep it at 1 for atmosphere)

            // 2. Wait for the content fade-out duration (1.5s)
            setTimeout(() => {
                // 3. Update the content
                showStoryNode(nextNode);
            }, STORY_TRANSITION_DURATION_MS);
        }

        // Simplified content fade logic.
        function showStoryNode(nodeName) {
            if (nodeName === 'title_screen') {
                showScreen('start');
                return;
            }

            // Start ambiance and blinking if needed
            startAmbiance();
            if (gameSettings.blinkingEffect === 'on') {
                startBlinkingTimer();
            }

            // Ensure TOTAL_ENDINGS is calculated before processing an ending/death
            calculateTotalEndings();
            const node = window.storyNodes[nodeName];
            let htmlContent = '';
            
            // Handle ENDING/DEATH nodes
            if (node.isEnding || node.isDeath) {
                // === BUG FIX START: Ensure Return to Title Screen button for all endings/deaths ===
                // This line guarantees that all endings and deaths will have a single button
                // to return to the title screen, fixing the issue where some endings failed to display it.
                node.choices = [{ text: "Return to Title Screen", nextNode: "title_screen" }];
                // === BUG FIX END ===

                // 1. Mark as unlocked in localStorage
                const unlockedEndings = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                // Find the node key by its endingId (Id 1-54)
                const nodeKey = Object.keys(window.storyNodes).find(key => window.storyNodes[key].endingId === node.endingId && (window.storyNodes[key].isEnding || window.storyNodes[key].isDeath) );
                
                if (nodeKey && !unlockedEndings.includes(nodeKey)) {
                    unlockedEndings.push(nodeKey);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(unlockedEndings));
                }

                // DYNAMIC TITLE GENERATION
                const prefix = node.isEnding ? "ENDING" : "GAME OVER";
                let dynamicTitle;
                if (node.isEnding) {
                    // Main endings replace the X/Y part (e.g., 1/30) with the dynamic endingId/TOTAL_ENDINGS (e.g., 1/54)
                    dynamicTitle = node.endingTitle.replace(/(\d+)\/(\d+)/, `${node.endingId}/${TOTAL_ENDINGS}`);
                } else {
                    // Death endings use the GAME OVER prefix, and a format like (31/54)
                    dynamicTitle = `${prefix} (${node.endingId}/${TOTAL_ENDINGS}): ${node.endingDescription}`;
                }
                
                htmlContent = `
                    <h2>${dynamicTitle}</h2>
                    <p class="description">${node.text}</p>
                `;
                stopBlinking(); // Stop blinking on game over/ending
            } else if (node.isTitle) {
                // If the node is a placeholder to return to the title screen, handle the transition
                handleInGameTransition('title_screen');
                return;
            } else {
                // Regular story node
                htmlContent = `<p>${node.text}</p>`;
            }

            // 1. Update the content
            storyTextEl.innerHTML = htmlContent;
            choicesEl.innerHTML = ''; // Clear old choices

            // 2. Add choice buttons
            if (node.choices && node.choices.length > 0) {
                node.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.classList.add('choice-btn');
                    button.textContent = choice.text;
                    button.onclick = () => handleInGameTransition(choice.nextNode);
                    choicesEl.appendChild(button);
                });
            } else if (!node.isEnding && !node.isDeath) {
                // No choices defined for a non-ending node (should not happen in a complete game)
                storyTextEl.innerHTML += "<p style='color:#f55'>**[ERROR: Missing choices for this node. Returning to start.]**</p>";
                const button = document.createElement('button');
                button.classList.add('choice-btn');
                button.textContent = "Return to Title Screen";
                button.onclick = () => handleInGameTransition('title_screen');
                choicesEl.appendChild(button);
            }

            // 3. Fade the content back in (1.5s)
            setTimeout(() => {
                storyTextEl.style.opacity = '1';
                choicesEl.style.opacity = '1';
            }, 50); // Small delay to ensure browser registers content change before transition

            // 4. Update the history for back button functionality (optional, not implemented here)
        }


        // --- Event Listeners ---
        
        // Start Button: Wraps the screen change to ensure audio starts
        startButtonEl.addEventListener('click', () => handleStartScreenClick(() => showScreen('game')));

        // Settings Button: Wraps the screen change to ensure audio starts
        settingsButtonEl.addEventListener('click', () => handleStartScreenClick(toggleSettingsMenu));

        // Settings Save Button: Does not need the wrapper as it's not a *first* click event.
        settingsSaveButtonEl.addEventListener('click', saveSettings);
        
        // Mouse movement for flashlight and eye tracking
        document.addEventListener('mousemove', (e) => {
            // 1. Flashlight (Always active)
            document.body.style.setProperty('--x', `${e.clientX}px`);
            document.body.style.setProperty('--y', `${e.clientY}px`);
            
            // 2. Eye Tracking (Only active on 'better' graphics and if eyes are rendered)
            if (gameSettings.graphics === 'better') {
                trackEyes(e.clientX, e.clientY);
            }
        });


        // Re-render eyes on window resize to maintain non-overlapping constraint
        window.addEventListener('resize', () => {
            if (gameSettings.graphics === 'better') {
                eyePositions = []; // Force regeneration on resize
                renderEyes();
            }
        });


        // Initialize the game state when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadAndApplySettings(); 
            window.populateEndingsList(); // Ensure list is ready
            calculateTotalEndings();
            showScreen('start');
        });
        
    </script>
</body>
</html>
