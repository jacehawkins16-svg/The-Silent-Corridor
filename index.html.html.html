<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Silent Corridor: Expanded Edition</title>
    <link rel="icon" type="image/png" href="icon.png">
    <style>

/* Global Styles & Atmosphere */
body {
    /* 1. AMBIENT BACKGROUND: Dark Red/Black (Default for Low Graphics) - This is the normal background */
    background-color: #110000; 
    color: #aaa; 
    font-family: 'Courier New', Courier, monospace;
    display: flex;
    justify-content: center;
    align-items: center; 
    height: 100vh;
    width: 100vw; 
    margin: 0;
    padding: 0; 
    overflow: hidden; 
    
    position: relative;
    z-index: 0; 
    
    /* Flashlight Variables */
    --x: 50vw; 
    --y: 50vh; 
    --flashlight-size: 300px; 

    /* Set a fixed dark background, NOT a gradient, to serve as the ambient color */
    background: #110000; 
    background-attachment: fixed;
    transition: none !important; 
}

/* NEW: Background Distortion on Better Graphics */
body.better-graphics-active {
    /* Subtle overall distortion filter */
    filter: hue-rotate(2deg) contrast(0.98); 
    transition: filter 1.0s ease-in-out; 
}


/* 2. body::before provides the WHITE/RED light color over the ambient background */
body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 10; 
    pointer-events: none; 
    
    /* THE LIGHT COLOR: Soft white center with red edge fading to transparent (reveals ambient body background) */
    background: radial-gradient(
        circle var(--flashlight-size) at var(--x) var(--y), 
        rgba(255, 255, 255, 0.15) 0%,     /* Bright center */
        rgba(255, 85, 85, 0.05) 50%,    /* Red glow */
        transparent 100% 
    );
    background-blend-mode: overlay; 
}

/* 3. body::after is the BLACK SHADOW MASK with a transparent hole */
body::after {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 12; 
    pointer-events: none;

    background-color: #000; 
    opacity: 0.95; 
    
    /* THE MASK: Creates a transparent hole in the shadow layer */
    mask-image: radial-gradient(
        circle var(--flashlight-size) at var(--x) var(--y),
        transparent 0%, 
        transparent 70%,
        black 100% 
    );
    -webkit-mask-image: radial-gradient(
        circle var(--flashlight-size) at var(--x) var(--y),
        transparent 0%,
        transparent 70%,
        black 100%
    );
}

/* --- Eye Tracking CSS - CREEPY VERSION --- */
#eye-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    /* Place eyes above the light source (z-index 10) but below the shadow mask (z-index 12) */
    z-index: 11; 
    pointer-events: none;
    
    /* NEW: Start invisible and fade in/out */
    opacity: 0; 
    transition: opacity 1.0s ease-in-out; 
}

.eye {
    position: absolute;
    width: 45px; /* Wider */
    height: 35px; /* Shorter for oval shape */
    background: #440000; /* Dark, unsettling sclera */
    /* Oval shape (width 50%, height 40%) */
    border-radius: 50% / 40%;
    border: 1px solid #770000;
    /* Subtle red glow/shadow for bloodshot/supernatural effect */
    box-shadow: 0 0 10px rgba(255, 50, 50, 0.4), 
                inset 0 0 5px rgba(255, 50, 50, 0.2); 
    /* Removed individual eye opacity transition, using container instead */
}

.eye-pupil {
    position: absolute;
    top: 50%;
    left: 50%;
    /* Keep it centered initially before JS moves it */
    transform: translate(-50%, -50%); 
    width: 8px; /* Narrow slit */
    height: 25px; /* Vertical slit length */
    background: #000; /* Pure black void */
    /* Slit shape */
    border-radius: 4px;
    box-shadow: 0 0 5px #ff5555; /* Creepy red glow around pupil */
}

.eye-pupil::after {
    /* Hidden: We use the whole element as the pupil/iris now */
    display: none; 
}


/* NEW: Camera Effect Overlay (for Better Graphics setting) */
#camera-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 50; 
    pointer-events: none; 
    opacity: 0; 
    transition: opacity 1.0s ease-in-out;
}

#camera-overlay.active {
    opacity: 1; 
    /* Camera Effect: Greenish noise, scan lines, and vignette */
    background: 
        /* 1. Subtle green/red vignette */
        radial-gradient(ellipse at center, rgba(0, 0, 0, 0) 0%, rgba(10, 0, 0, 0.2) 60%, rgba(0, 5, 0, 0.5) 100%),
        /* 2. Film grain/noise */
        repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(0, 0, 0, 0.2) 2px, rgba(0, 0, 0, 0.2) 3px),
        /* 3. Color tint */
        rgba(50, 0, 0, 0.1); 
    
    /* Distortion Effects */
    filter: brightness(1.2) contrast(1.1) hue-rotate(5deg) blur(0.5px);
    transform: scale(1.005);
}

/* NEW: Rain Effect Overlay */
#rain-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1; 
    pointer-events: none;
    background-image: url('rain.png');
    background-repeat: repeat; 
    background-size: 150px 150px; 
    /* REMOVED static opacity: now controlled by JS (0 for low, 0.2 for better) */
    transition: opacity 0.5s ease-out; /* Added transition for smooth hide/show */
    animation: fallingRain 0.5s linear infinite; 
}

@keyframes fallingRain {
    from {
        background-position: 0 0;
    }
    to {
        background-position: -300px 300px; 
    }
}

/* --- MODIFIED: Blink Overlays (2-Second Duration) --- */
#blink-top, #blink-bottom {
    position: fixed;
    left: 0;
    width: 100vw;
    height: 50vh; /* Half the screen height */
    z-index: 60; /* Highest z-index */
    background-color: #000;
    pointer-events: none;
    transition: none; /* No default transition */
}

#blink-top {
    top: 0;
    transform: translateY(-100%); /* Start completely off the top */
}

#blink-bottom {
    bottom: 0;
    transform: translateY(100%); /* Start completely off the bottom */
}

/* MODIFIED: Blink Animations (1s close, 1s open) */
/* Top eyelid moves down */
@keyframes playerBlinkTop {
    0% { transform: translateY(-100%); } /* Start off-screen */
    50% { transform: translateY(0%); }   /* MODIFIED: Close to the middle at 50% (1.0s) */
    100% { transform: translateY(-100%); } /* MODIFIED: Open back to off-screen at 100% (1.0s) */
}

/* Bottom eyelid moves up */
@keyframes playerBlinkBottom {
    0% { transform: translateY(100%); } /* Start off-screen */
    50% { transform: translateY(0%); }  /* MODIFIED: Close to the middle at 50% (1.0s) */
    100% { transform: translateY(100%); } /* MODIFIED: Open back to off-screen at 100% (1.0s) */
}

/* Apply the animation when the body has the 'is-blinking' class */
body.is-blinking #blink-top {
    animation: playerBlinkTop 2.0s ease-in-out forwards; 
}

body.is-blinking #blink-bottom {
    animation: playerBlinkBottom 2.0s ease-in-out forwards; 
}


.container {
    width: 80vh; 
    height: 80vh; 
    max-width: 95%; 
    max-height: 95vh; 
    
    box-sizing: border-box;
    overflow-y: auto; 
    overflow-x: hidden; 
    
    text-align: left;
    line-height: 1.6;
    animation: none !important; 
    
    /* Default background for low graphics (75% opacity) */
    background-color: rgba(17, 0, 0, 0.75); 
    background-image: none; /* Ensure no gradient is present by default */
    
    padding: 20px; 
    border-radius: 5px;
    box-shadow: none; 
    position: relative; 
    transition: margin-left 0.5s, background 0.5s; /* Added background transition */
    
    /* FIX: Lowered Z-index from 13 to 11 so the Shadow Mask (z-index 12) can dim the content */
    z-index: 11; 
}

/* UPDATED: Special background for Better Graphics (15% opacity/85% transparent with fade) */
body.better-graphics-active .container {
    background-color: transparent; /* Must be transparent to allow gradient */
    background-image: radial-gradient(
        circle at center,
        rgba(50, 0, 0, 0.15) 0%,    /* Dark Red Center (15% opacity) */
        rgba(0, 0, 0, 0.15) 75%,    /* Black at 75% radius (15% opacity) */
        rgba(0, 0, 0, 0.0) 100%     /* Fully transparent at edge (fades into body ambient) */
    );
}
        h1 {
            color: #f55; 
            text-align: center;
            border-bottom: 1px solid #f55; 
            padding-bottom: 10px;
            text-transform: uppercase;
        }
        
        /* NEW: Added transition for the game title to fade in */
        #game-title {
            opacity: 1; /* Default to visible in case JS fails */
            transition: opacity 1.5s ease-in-out;
        }

        /* --- Screen Management --- */
        .screen {
            display: none;
            opacity: 1;
            /* MODIFIED: Reduced transition time from 2.0s to 1.0s */
            transition: opacity 1.0s ease-in-out; 
            box-sizing: border-box; 
        }
        .screen.active {
            display: block;
        }
        
        .fade-out {
            opacity: 0 !important; 
        }

/* --- Start Menu & Animation Styles --- */
#start-screen, #settings-screen { 
    text-align: center;
    padding: 10vh 40px; 
}

        #start-title {
            font-size: 2.5em;
            margin-bottom: 40px;
            border-bottom: none; 
            padding-bottom: 0;
            animation-name: titleMove; 
            animation-duration: 4s;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
            animation-direction: alternate;
        }
        @keyframes titleMove {
            0% { transform: translateX(-10px) rotate(-1.5deg); }
            50% { transform: translateX(10px) rotate(1.5deg); }
            100% { transform: translateX(-10px) rotate(-1.5deg); }
        }

        #start-button, #endings-button, #settings-button { 
            max-width: 300px;
            margin: 10px auto; 
            font-size: 1.2em;
            padding: 15px 30px;
            border-color: #f55; 
            width: auto !important; 
        }

        /* --- Game Screen Elements --- */
#game-screen {
    opacity: 0; 
    /* MODIFIED: Reduced transition time from 2.0s to 1.0s */
    transition: opacity 1.0s ease-in-out; 
}
#game-screen.active {
    display: block; 
    opacity: 1; 
}

#story-text, #choices {
    opacity: 0; 
    transition: opacity 1.5s ease-in-out; 
}
        
        #story-text {
            margin-top: 20px;
            font-size: 1em;
            min-height: 200px; 
        }
        
        #story-text h2 { 
            text-align: center;
            font-size: 1.5em;
            color: #f55; 
            margin-top: 20px;
            border-bottom: none;
            text-transform: none;
        }
        
        #story-text p.description {
            margin-bottom: 30px;
            font-style: italic;
        }
        
        /* Interaction Buttons */
        .choice-btn {
            background-color: transparent;
            border: 1px solid #f55; 
            color: #f55; 
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            transition: color 0.3s, background-color 0.3s, border-color 0.3s;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }
        .choice-btn:hover {
            color: #fff; 
            border-color: #fff; 
            background-color: #220000; 
        }
        
        /* Game Over State */
        .game-over h1, .game-over .choice-btn {
            color: #ff0000; 
            border-color: #ff0000; 
        }
        .game-over .choice-btn:hover {
            background-color: #330000; 
        }
        
/* --- Settings Screen Styles --- */
#settings-screen {
    padding-top: 20px;
}
.setting-group {
    margin-bottom: 20px;
    padding: 10px;
    border: 1px dashed #f555;
    border-radius: 5px;
}
.setting-group label {
    display: block;
    margin-bottom: 8px;
    color: #f55;
    font-size: 1.1em;
    text-align: left;
}
.settings-slider, .settings-select {
    width: 100%;
    background-color: #220000;
    border: 1px solid #444;
    color: #fff;
    padding: 5px;
    font-family: 'Courier New', Courier, monospace;
    box-sizing: border-box;
    border-radius: 3px;
}
/* Custom slider styles for spooky feel */
.settings-slider {
    -webkit-appearance: none;
    height: 10px;
    border-radius: 5px;
    background: #440000;
    outline: none;
    cursor: pointer;
}
.settings-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background: #f55;
    cursor: pointer;
}
        
/* --- ENDINGS MENU SIDEBAR --- */
#endings-sidebar {
    height: 90vh; 
    width: 300px; 
    position: fixed;
    z-index: 20; 
    top: 50%; 
    right: 0;
    background-color: rgba(17, 0, 0, 0.9); 
    overflow-x: hidden;
    transition: 0.5s;
    padding-top: 20px; 
    /* PUSH OFF-SCREEN and VERTICALLY CENTER */
    transform: translateY(-50%) translateX(100%); 
    box-shadow: -5px 0 15px rgba(255, 85, 85, 0.2); 
    border-left: 1px solid #f55; 
    display: flex;
    flex-direction: column;
}

#endings-sidebar.open {
    /* PULL BACK ON-SCREEN while maintaining vertical center */
    transform: translateY(-50%) translateX(0); 
}

#endings-list-content {
    padding: 0 15px 15px 15px;
    overflow-y: auto;
    flex-grow: 1; 
}

        #endings-sidebar h3 {
            color: #f55; 
            text-align: center;
            margin-top: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f55; 
            text-transform: uppercase;
            font-size: 1.2em;
        }

        .ending-item {
            padding: 8px 0;
            border-bottom: 1px dotted #444; 
            color: #666; 
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
            line-height: 1.2;
        }

        .ending-item.unlocked {
            color: #aaa; 
            font-weight: bold;
        }

        .ending-item .status {
            color: #ff0000; 
            margin-left: 10px;
            min-width: 10px; 
        }
        
        .ending-item.unlocked .status {
            color: #44ff44; 
        }
        
        .ending-name {
            flex-grow: 1; 
        }
        
        .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
            cursor: pointer;
            color: #f55; 
            text-decoration: none;
            line-height: 60px;
        }

        /* Adjustment to push main content when sidebar is open */
        body.sidebar-open .container {
            margin-right: 300px; 
        }

@media (max-width: 768px) {
    .container {
        width: 90vw; 
        height: 90vw; 
        max-width: none; 
    }
    /* NEW: Use 90% width on smaller screens */
    #endings-sidebar {
        width: 90%;
    }
    /* Adjust content spacing for smaller screens */
    #story-text {
        min-height: 150px; 
    }
}

/* --- Custom Scrollbar Styling for Aesthetics --- */
/* Targetting the element with isolated scrolling */
#endings-list-content::-webkit-scrollbar {
    width: 8px;
    background-color: #111; 
}

#endings-list-content::-webkit-scrollbar-thumb {
    background-color: #f55; 
    border-radius: 4px;
    border: 1px solid #330000; 
}

#endings-list-content::-webkit-scrollbar-thumb:hover {
    background-color: #fff; 
}
    </style>
</head>
<body>
    
    <audio id="rainAmbiance" loop src="rain sfx.mp3"></audio>
    
    <div id="camera-overlay"></div> 
    <div id="rain-overlay"></div> 
    
    <div id="blink-top"></div>
    <div id="blink-bottom"></div>

    <div id="eye-container"></div> 
    
    <div id="endings-sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="toggleEndingsMenu()">&times;</a>
        <h3>Endings Tracker</h3>
        <div id="endings-list-content">
            </div>
    </div>
    
    <div class="container" id="gameContainer">
        
        <div id="start-screen" class="screen active">
            <h1 id="start-title">The Silent Corridor</h1>
            <button id="start-button" class="choice-btn">BEGIN NIGHTMARE</button>
            
            <button id="settings-button" class="choice-btn">SETTINGS</button> 
            
            <button id="endings-button" class="choice-btn" onclick="toggleEndingsMenu()">ENDINGS</button>
        </div>

        <div id="settings-screen" class="screen">
            <h1>Game Settings</h1>
            
            <div class="setting-group">
                <label for="graphics-quality">Graphics Quality:</label>
                <select id="graphics-quality" class="settings-select">
                    <option value="low">Low (Standard)</option>
                    <option value="better">Better (Camera Overlay & Rain & Eyes)</option>
                </select>
                <p style="font-size: 0.8em; margin-top: 5px; color: #777;">Better quality adds a static camera filter, a subtle rain effect, and **10 tracking eyes** for atmosphere.</p>
            </div>

            <div class="setting-group">
                <label for="flashlight-intensity">Flashlight Intensity (<span id="flashlight-value">300</span>px):</label>
                <input type="range" id="flashlight-intensity" class="settings-slider" min="100" max="300" step="10">
                <p style="font-size: 0.8em; margin-top: 5px; color: #777;">Adjusts the radius of the light cone (100px - 300px).</p>
            </div>
            
            <div class="setting-group">
                <label for="blinking-effect">Player Blinking (10-30s interval):</label>
                <select id="blinking-effect" class="settings-select">
                    <option value="on">On (Default)</option>
                    <option value="off">Off</option>
                </select>
                <p style="font-size: 0.8em; margin-top: 5px; color: #777;">Simulates the player's eyes blinking at random intervals.</p>
            </div>

            <button id="settings-save-button" class="choice-btn" style="margin-top: 20px;">SAVE & RETURN</button>
        </div>
        
        <div id="game-screen" class="screen">
            <h1 id="game-title">The Silent Corridor</h1>
            <div id="story-text">
                </div>
            <div id="choices">
                </div>
        </div>
    </div>
    <script>
        // --- Game Logic and State Management ---
        const storyTextEl = document.getElementById('story-text');
        const choicesEl = document.getElementById('choices');
        const gameContainerEl = document.getElementById('gameContainer');
        // NEW: Game Title reference
        const gameTitleEl = document.getElementById('game-title');

        const startScreenEl = document.getElementById('start-screen');
        const gameScreenEl = document = document.getElementById('game-screen');
        const startButtonEl = document.getElementById('start-button'); 

        const sidebarEl = document.getElementById('endings-sidebar');
        const listContentEl = document.getElementById('endings-list-content');
        
        // Settings elements
        const settingsScreenEl = document.getElementById('settings-screen');
        const settingsButtonEl = document.getElementById('settings-button');
        const settingsSaveButtonEl = document.getElementById('settings-save-button');
        const cameraOverlayEl = document.getElementById('camera-overlay');
        const rainOverlayEl = document.getElementById('rain-overlay'); 
        const flashlightSliderEl = document.getElementById('flashlight-intensity');
        const flashlightValueEl = document.getElementById('flashlight-value');
        const graphicsSelectEl = document.getElementById('graphics-quality');
        
        // MODIFIED: Blink Overlay elements and Select Element
        const blinkTopEl = document.getElementById('blink-top'); 
        const blinkBottomEl = document.getElementById('blink-bottom');
        const blinkingSelectEl = document.getElementById('blinking-effect');
        
        // Eye container element
        const eyeContainerEl = document.getElementById('eye-container'); 

        // Audio element
        const rainAmbiance = document.getElementById('rainAmbiance');
        
        // NEW: Constant for the animation duration (2000ms = 2 seconds)
        const BLINK_ANIMATION_DURATION_MS = 2000;
        // Global variable for blinking timer
        let blinkingTimer = null; 

        // Settings Logic & State Management
        const SETTINGS_KEY = 'silentCorridorSettings';
        const defaultSettings = {
            graphics: 'low',
            flashlightIntensity: 300,
            blinkingEffect: 'on' // NEW: Replaced glitchEffect
        };
        let gameSettings = {};
        
        // Tracking the previous setting for eye position persistence logic
        let previousGraphicsSetting = 'low'; 
        
        // FIX: Global variable to track the clearEyes timeout
        let clearEyesTimeout = null; 
        


        // Function to load and apply settings
        function loadAndApplySettings() {
            try {
                const storedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY));
                gameSettings = storedSettings ? { ...defaultSettings, ...storedSettings } : defaultSettings;
                
                // Compatibility for old settings format (if user had old version)
                if (storedSettings && storedSettings.glitchEffect !== undefined) {
                    gameSettings.blinkingEffect = storedSettings.glitchEffect;
                    delete gameSettings.glitchEffect;
                }
            } catch (e) {
                console.error("Error loading settings from localStorage:", e);
                gameSettings = defaultSettings;
            }
            // Initialize previous setting tracker on load
            previousGraphicsSetting = gameSettings.graphics; 
            applySettings();
        }

        // Function to apply settings to the DOM/CSS
        function applySettings() {
            // 1. Flashlight Intensity
            document.body.style.setProperty('--flashlight-size', `${gameSettings.flashlightIntensity}px`);

            // 2. Graphics Quality (Camera Overlay, Rain, Eyes, and Body Distortion)
            const currentGraphics = gameSettings.graphics;

            if (currentGraphics === 'better') {
                cameraOverlayEl.classList.add('active');
                rainOverlayEl.style.opacity = '0.2'; 
                document.body.classList.add('better-graphics-active'); 
                
                // If we are *toggling* from low to better, reset positions for a fresh start.
                if (previousGraphicsSetting === 'low') {
                     eyePositions = []; 
                }
                renderEyes(); 
            } else { // currentGraphics === 'low'
                cameraOverlayEl.classList.remove('active');
                rainOverlayEl.style.opacity = '0'; 
                document.body.classList.remove('better-graphics-active'); 
                
                clearEyes(); 
                
                // When we turn off better graphics, we clear the positions.
                // This ensures the next time 'better' is selected, new positions are generated.
                eyePositions = []; 
            }
            
            previousGraphicsSetting = currentGraphics; // Update tracking variable

            // 3. Blinking Effect (Now starts/stops regardless of active screen)
            if (gameSettings.blinkingEffect === 'on') {
                startBlinking(); // FIX: Call new function to ensure immediate blink and timer start
            } else {
                stopBlinking();
            }
        }
        
        // Function to render the settings UI based on current settings
        function renderSettings() {
            flashlightSliderEl.value = gameSettings.flashlightIntensity;
            flashlightValueEl.textContent = gameSettings.flashlightIntensity;
            graphicsSelectEl.value = gameSettings.graphics;
            blinkingSelectEl.value = gameSettings.blinkingEffect; // UPDATED to blinkingEffect
            
            // Live update for flashlight slider display and CSS variable for live preview
            flashlightSliderEl.oninput = function() {
                flashlightValueEl.textContent = this.value;
                document.body.style.setProperty('--flashlight-size', `${this.value}px`);
            };

            // Live update for graphics quality on change
            graphicsSelectEl.onchange = function() {
                // Temporarily update and apply the setting for live preview
                if (this.value === 'better') {
                    cameraOverlayEl.classList.add('active');
                    rainOverlayEl.style.opacity = '0.2'; 
                    document.body.classList.add('better-graphics-active');
                    // Force a new position for the preview
                    eyePositions = []; 
                    renderEyes(); 
                } else {
                    cameraOverlayEl.classList.remove('active');
                    rainOverlayEl.style.opacity = '0';
                    document.body.classList.remove('better-graphics-active');
                    clearEyes();
                    // Don't reset eyePositions here, as it will be reset in saveSettings if the user saves "low".
                }
            };
        }
        
        // Function to save settings and return
        function saveSettings() {
            // 1. Store the previous setting before updating
            const oldGraphics = gameSettings.graphics;
            
            // 2. Update gameSettings object
            gameSettings.flashlightIntensity = parseInt(flashlightSliderEl.value);
            gameSettings.graphics = graphicsSelectEl.value;
            gameSettings.blinkingEffect = blinkingSelectEl.value; // UPDATED to blinkingEffect
            
            // 3. Save to storage
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(gameSettings));
            } catch (e) {
                console.error("Error saving settings to localStorage:", e);
            }

            // 4. If graphics changed *while in settings*, the live preview cleared the eyes.
            // We need to re-apply settings fully to ensure the final state is correct.
            applySettings();

            // 5. Return to Start Screen
            toggleSettingsMenu();
        }

        // Function to toggle the settings screen visibility
        function toggleSettingsMenu() {
            if (settingsScreenEl.classList.contains('active')) {
                // Hiding settings screen, show start screen
                // IMPORTANT: Restore flashlight slider preview to saved value before returning
                document.body.style.setProperty('--flashlight-size', `${gameSettings.flashlightIntensity}px`); 
                
                // If graphics are still "better" on exit, ensure eyes are visible (they might have been hidden by a live setting change)
                if(gameSettings.graphics === 'better' && eyeContainerEl.style.opacity === '0') {
                     // Ensure the eyes are visible and tracking immediately on exit
                     eyeContainerEl.style.opacity = '1'; 
                }
                
                settingsScreenEl.classList.remove('active');
                startScreenEl.classList.add('active');
            } else {
                // Showing settings screen, hide start screen
                startScreenEl.classList.remove('active');
                renderSettings(); // Ensure UI reflects current settings
                settingsScreenEl.classList.add('active');
            }
        }

        // --- Eye Tracking Logic (Remains unchanged) ---
        const EYE_COUNT = 10;
        const EYE_SIZE = 45; // Width of the new oval eye
        const EYE_HEIGHT = 35; // Height of the new oval eye
        const MIN_DISTANCE = 75; // Minimum distance between centers in pixels
        const MAX_PUPIL_MOVE = 6; 
        
        let eyePositions = []; // Global storage for persistent positions

        function generateEyePositions() {
            const positions = [];
            // Use 90% of screen size to keep eyes away from edges
            const containerWidth = window.innerWidth * 0.9;
            const containerHeight = window.innerHeight * 0.9;
            const offsetX = window.innerWidth * 0.05;
            const offsetY = window.innerHeight * 0.05;

            for (let i = 0; i < EYE_COUNT; i++) {
                let newX, newY, attempts = 0;
                let isOverlapping = true;

                while (isOverlapping && attempts < 100) {
                    // Generate random position within the 90% bounds
                    newX = Math.random() * containerWidth + offsetX;
                    newY = Math.random() * containerHeight + offsetY;
                    
                    isOverlapping = false;
                    
                    // Check against existing positions
                    for (const pos of positions) {
                        // Calculate distance between centers (Pythagorean theorem)
                        const distance = Math.sqrt(Math.pow(newX - pos.x, 2) + Math.pow(newY - pos.y, 2));
                        
                        if (distance < MIN_DISTANCE) {
                            isOverlapping = true;
                            break;
                        }
                    }
                    attempts++;
                }

                if (!isOverlapping) {
                    positions.push({ x: newX, y: newY });
                }
            }
            return positions;
        }
        
        function ensureEyePositions() {
            // Only generate new positions if the global array is empty
            if (eyePositions.length === 0) {
                eyePositions = generateEyePositions();
            }
        }

        function renderEyes() {
            if (gameSettings.graphics !== 'better') return;

            // 1. Check if positions were empty before trying to ensure them.
            const wasEmpty = eyePositions.length === 0;
            ensureEyePositions(); 
            
            // 2. Only draw the HTML if we are forced to (wasEmpty) or if the container is currently empty.
            if (wasEmpty || eyeContainerEl.innerHTML === '') {
                
                // FIX: If we are redrawing from scratch, clear any pending timeouts
                if (wasEmpty && clearEyesTimeout) {
                    clearTimeout(clearEyesTimeout);
                    clearEyesTimeout = null;
                }
                
                // Always clear the container synchronously before redrawing to prevent race conditions
                eyeContainerEl.innerHTML = ''; 
                
                eyePositions.forEach(pos => {
                    const eye = document.createElement('div');
                    eye.classList.add('eye');
                    // Set position based on center coordinates
                    eye.style.left = `${pos.x}px`;
                    eye.style.top = `${pos.y}px`;
                    // Center the eye div on the calculated position
                    eye.style.transform = `translate(-${EYE_SIZE/2}px, -${EYE_HEIGHT/2}px)`; 
                    
                    const pupil = document.createElement('span');
                    pupil.classList.add('eye-pupil');
                    eye.appendChild(pupil);
                    
                    eyeContainerEl.appendChild(eye);
                });
            }
            
            // FADE IN (transition handled by CSS)
            // Use a short delay to ensure rendering is complete before setting opacity
            setTimeout(() => {
                eyeContainerEl.style.opacity = '1';
            }, 50);
        }


        function clearEyes() {
            // FIX: Clear any existing timeout before starting a new one
            if (clearEyesTimeout) {
                clearTimeout(clearEyesTimeout);
                clearEyesTimeout = null;
            }

            // FADE OUT (transition handled by CSS)
            eyeContainerEl.style.opacity = '0';
            
            // Wait for the fade to complete before clearing innerHTML
            clearEyesTimeout = setTimeout(() => {
                eyeContainerEl.innerHTML = '';
                clearEyesTimeout = null; // Reset the tracker
            }, 1000); // Must match the CSS transition time (1.0s)
        }

        function trackEyes(mouseX, mouseY) {
            const eyes = document.querySelectorAll('.eye');
            
            eyes.forEach(eye => {
                const rect = eye.getBoundingClientRect();
                // Eye center coordinates
                const eyeX = rect.left + rect.width / 2;
                const eyeY = rect.top + rect.height / 2;

                // Vector from eye center to mouse position
                const dx = mouseX - eyeX;
                const dy = mouseY - eyeY;

                // Angle calculation
                const angle = Math.atan2(dy, dx);

                // Clamp movement distance to MAX_PUPIL_MOVE
                const distance = Math.min(MAX_PUPIL_MOVE, Math.sqrt(dx * dx + dy * dy));

                // New pupil position relative to the eye center
                const pupilX = Math.cos(angle) * distance;
                const pupilY = Math.sin(angle) * distance;

                // Apply transformation: keep it centered (-50%, -50%) then translate to tracking position
                const pupil = eye.querySelector('.eye-pupil');
                pupil.style.transform = `translate(-50%, -50%) translate(${pupilX}px, ${pupilY}px)`;
            });
        }
        
        // --- Blinking Logic (UPDATED) ---

        function playerBlink() {
            // The animation is triggered via the body class now
            document.body.classList.add('is-blinking');
            
            // Remove the class after the animation is complete (2.0s)
            setTimeout(() => {
                document.body.classList.remove('is-blinking');
            }, BLINK_ANIMATION_DURATION_MS); 
        }
        
        // NEW: Function to initiate blinking (immediate blink + timer start)
        function startBlinking() {
            if (gameSettings.blinkingEffect === 'on') {
                stopBlinking(); // Ensure only one timer is running
                playerBlink(); // User requested immediate blink on load/start
                startBlinkingTimer(); // Start the recursive timer
            }
        }

        // RENAMED (to avoid confusion with the initial start) and logic modified.
        function startBlinkingTimer() {
            // Clear any existing timer
            if (blinkingTimer) {
                clearTimeout(blinkingTimer);
                blinkingTimer = null;
            }
            
            if (gameSettings.blinkingEffect === 'off') {
                return;
            }
            
            // Random delay between 10 to 30 seconds (10000ms to 30000ms) - FIXED RANGE
            const randomDelay = Math.random() * 20000 + 10000; 

            blinkingTimer = setTimeout(() => {
                playerBlink();
                // Set the timer again for the next blink
                startBlinkingTimer(); 
            }, randomDelay);
        }

        function stopBlinking() {
            if (blinkingTimer) {
                clearTimeout(blinkingTimer);
                blinkingTimer = null;
            }
            // Ensure no active blink by removing the class from the body
            document.body.classList.remove('is-blinking'); 
        }


        // CRITICAL MODIFICATION: Duration for the in-game content transition fade (1.5 seconds)
        const STORY_TRANSITION_DURATION_MS = 1500;
        let TOTAL_ENDINGS = 54; 
        const STORAGE_KEY = 'silentCorridorEndings';
        
        // --- Story Node Data Structure (Unchanged) ---
        // All ending nodes (isEnding: true) should have an endingId (1-30 for old, 31-54 for new)
        window.storyNodes = {
            // --- Starting Node ---
            start: {
                text: "You awaken in a familiar yet unsettling house. The clock reads **3:07 AM**. A suffocating **silence** hangs in the air, a physical weight that presses against your eardrums. Your only light is the beam of your **flashlight**, which casts long, distorted shadows.",
                choices: [
                    { text: "Go to the Living Room.", nextNode: "living_room_start" },
                    { text: "Go to the Kitchen.", nextNode: "kitchen_start" },
                    { text: "Check the Bathroom.", nextNode: "bathroom_start" },
                    { text: "Go back to the Bedroom.", nextNode: "bedroom_start" },
                    { text: "Wait in the Corridor.", nextNode: "corridor_wait" }
                ],
                isTitle: true, // Only for the first node after start screen
            },
            
            // --- Bedroom Path ---
            bedroom_start: {
                text: "Your bedroom is dark and empty. The bed is perfectly made, which is wrong. The **window** shows heavy rain, but you hear no sound. The **closet** door is slightly ajar.",
                choices: [
                    { text: "Look out the window.", nextNode: "bedroom_window" },
                    { text: "Check the closet.", nextNode: "bedroom_closet" },
                    { text: "Return to the corridor.", nextNode: "corridor_loop_1" }
                ]
            },
            bedroom_window: {
                text: "The glass is cold and reflects your image. The rain outside is a silent, frantic blur. You feel an overwhelming urge to escape through it.",
                choices: [
                    { text: "Smash the window with your flashlight.", nextNode: "death_window_smash" },
                    { text: "Try to open the window.", nextNode: "death_jump_41" }, 
                    { text: "Return to the bedroom.", nextNode: "bedroom_start" }
                ]
            },
            death_window_smash: {
                text: "You strike the glass. The sound is a dull thud. The glass does not break; instead, the shockwave of silent force shatters the bones in your arm. The pain is intense, but soundless.",
                endingDescription: "Shattered arm bones.",
                isDeath: true,
                endingId: 31,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }] 
            },
            bedroom_closet: {
                text: "The closet is full of identical black suits and dresses. On the floor is an old, leather-bound **journal** with a brass lock.",
                choices: [
                    { text: "Try to force the lock.", nextNode: "death_closet_lock" },
                    { text: "Leave the closet and return.", nextNode: "bedroom_start" }
                ]
            },
            death_closet_lock: {
                text: "The lock is enchanted. As you pull, it clamps down on your fingers, silently crushing them.",
                endingDescription: "Crushed fingers.",
                isDeath: true,
                endingId: 32,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            
            // --- Study Path (NEW) ---
            corridor_study_entrance: {
                text: "At the end of the corridor, a previously unseen door has materialized. It leads to a **Study**. You hesitate before entering.",
                choices: [
                    { text: "Enter the Study.", nextNode: "study_start" },
                    { text: "Go back to the corridor loop.", nextNode: "corridor_loop_1" }
                ]
            },
            study_start: {
                text: "The Study is lined with floor-to-ceiling **bookshelves**. In the center, a heavy **wooden desk** sits beneath a single, unblinking red light bulb.",
                choices: [
                    { text: "Examine the bookshelves.", nextNode: "study_bookshelf" },
                    { text: "Examine the wooden desk.", nextNode: "study_desk" },
                    { text: "Return to the corridor.", nextNode: "corridor_loop_1" }
                ]
            },
            study_desk: {
                text: "The desk is bare save for a stack of neatly folded **envelopes** and a very old, heavy, brass **handbell** with no clapper.",
                choices: [
                    { text: "Examine the envelopes.", nextNode: "study_desk_envelopes" },
                    { text: "Take the handbell.", nextNode: "study_desk_bell" },
                    { text: "Return to the study.", nextNode: "study_start" }
                ]
            },
            study_desk_envelopes: {
                text: "Each envelope contains a **single grain of sand**. The sand is cold and slightly magnetic. The house doesn't seem to care that you've found them.",
                choices: [
                    { text: "Return to the desk.", nextNode: "study_desk" }
                ]
            },
            study_desk_bell: {
                text: "You pocket the bell. It is useless without a clapper, but feels significant.",
                choices: [
                    { text: "Examine the desk again.", nextNode: "study_desk_envelopes" },
                    { text: "Return to the study.", nextNode: "study_start" }
                ]
            },
            study_bookshelf: {
                text: "The books are all dusty and uninteresting, except for one bound in heavy brass, titled 'The Compendium of Lost Sounds.' The books behind it seem slightly misaligned.",
                choices: [
                    { text: "Pull the brass-bound book.", nextNode: "ending_the_composer_43" },
                    { text: "Investigate the misaligned books.", nextNode: "study_bookshelf_2" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            study_bookshelf_2: {
                text: "The books are a false front. Behind them is a small, perfectly preserved **birdcage** containing a **single, black, flightless bird** that stares at you with a silent, malevolent gaze. It does not move.",
                choices: [
                    { text: "Open the cage and release the bird.", nextNode: "death_bird_release_44" },
                    { text: "Slam the false front shut and leave.", nextNode: "corridor_start" }
                ]
            },
            
            // --- Corridor/Corridor Loop Path ---
            corridor_loop_1: {
                text: "You walk for what feels like hours. Every door you pass leads back to your bedroom, which is now empty, the bed unmade. You realize the house is warping space around you. You are back in the main corridor, but it feels different.",
                choices: [
                    { text: "Go back to the living room.", nextNode: "living_room_start" },
                    { text: "Go back to the kitchen.", nextNode: "kitchen_start" },
                    { text: "Check the bathroom.", nextNode: "bathroom_start" }
                ]
            },
            corridor_wait: {
                text: "You decide to wait it out. The silence is a physical weight, pressing against your eardrums. You wait. And wait. The clock in your mind ticks past 4:00 AM, 5:00 AM... you are still waiting.",
                choices: [
                    { text: "Stay here until dawn (risky).", nextNode: "ending_27" },
                    { text: "Start tapping your feet rhythmically.", nextNode: "ending_28" }
                ]
            },
            
            // --- Living Room Path ---
            living_room_start: {
                text: "The living room is dominated by a silent, flickering **television**. A dusty **armchair** sits near the brick **fireplace**.",
                choices: [
                    { text: "Check the television.", nextNode: "living_room_tv" },
                    { text: "Go to the armchair.", nextNode: "living_room_armchair" },
                    { text: "Examine the fireplace.", nextNode: "living_room_fireplace" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            living_room_tv: {
                text: "The TV screen is static, but the hum is deafeningly quiet. It emits a faint, pulsing red light.",
                choices: [
                    { text: "Touch the screen.", nextNode: "death_tv_touch" },
                    { text: "Tap the TV screen like a code.", nextNode: "ending_14" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            living_room_armchair: {
                text: "The armchair is deep and smells of old tobacco. There's a hidden **hatch** beneath one of the cushions.",
                choices: [
                    { text: "Check under the other cushion.", nextNode: "ending_12" },
                    { text: "Examine the hatch.", nextNode: "living_room_armchair_hatch" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            living_room_fireplace: {
                text: "The fireplace is cold and smells of burnt wood. A small, rusty **chimney sweep** tool leans against the hearth.",
                choices: [
                    { text: "Attempt to climb the chimney (risk of getting stuck).", nextNode: "ending_chimney" },
                    { text: "Use the chimney sweep to poke the ashes.", nextNode: "living_room_fireplace_poke" }
                ]
            },
            living_room_fireplace_poke: {
                text: "You stir the ashes. Hidden beneath them is a small, smooth **white stone** and a tiny, almost invisible **switch** on the inside wall of the hearth.",
                choices: [
                    { text: "Take the white stone.", nextNode: "living_room_fireplace_stone" },
                    { text: "Flip the switch.", nextNode: "ending_26" }
                ]
            },
            living_room_fireplace_stone: {
                text: "You pocket the stone. It's oddly warm and vibrates slightly. You leave the switch alone for now.",
                choices: [
                    { text: "Look out the window.", nextNode: "living_room_window" },
                    { text: "Go to the armchair.", nextNode: "living_room_armchair" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            living_room_window: {
                text: "You peer out the window. It is raining heavily, but the rain makes no sound. Across the street, you see a faint **figure** standing perfectly still, watching the house. It is too dark to make out features.",
                choices: [
                    { text: "Stare intently at the figure.", nextNode: "ending_listen_still" },
                    { text: "Try to make a noise to get the figure's attention.", nextNode: "living_room_window_noise" }
                ]
            },
            living_room_window_noise: {
                text: "You can't shout, but you can tap the window glass. The sound is a dull, muffled thud, yet the figure across the street raises a hand and slowly points, not at you, but at the **television**.",
                choices: [
                    { text: "Check the television.", nextNode: "living_room_tv" },
                    { text: "Ignore the figure and return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            // --- Kitchen Path ---
            kitchen_start: {
                text: "The kitchen is a picture of domestic horror. The air is freezing, and on the floor, in front of the large, industrial-looking **freezer**, is a crudely painted, red **symbol**. A half-empty **milk bottle** sits on the counter.",
                choices: [
                    { text: "Investigate the red symbol.", nextNode: "kitchen_symbol" },
                    { text: "Check the freezer.", nextNode: "kitchen_freezer" },
                    { text: "Grab the milk bottle.", nextNode: "kitchen_milk_bottle" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            kitchen_symbol: {
                text: "The red symbol pulses faintly. It feels cold and slightly wet to the touch. You get the overwhelming feeling that if you step on it, the house wins.",
                choices: [
                    { text: "Try to wipe the symbol away.", nextNode: "death_wipe_symbol" },
                    { text: "Deliberately step on the symbol.", nextNode: "ending_15" },
                    { text: "Look around the rest of the kitchen.", nextNode: "kitchen_start" }
                ]
            },
            kitchen_freezer: {
                text: "The freezer is a monstrosity, humming a silent, deep tone. It is completely full of frozen food, mostly bags of peas and various vegetables. It has a large **crisper** drawer at the bottom.",
                choices: [
                    { text: "Open the crisper drawer.", nextNode: "death_crisper" },
                    { text: "Try to organize the frozen vegetables.", nextNode: "ending_21" },
                    { text: "Check behind the freezer (hard to reach).", nextNode: "kitchen_behind_freezer" }
                ]
            },
            kitchen_behind_freezer: {
                text: "You manage to squeeze behind the freezer. You find a loose piece of **chalk** that seems oddly pristine.",
                choices: [
                    { text: "Take the chalk and return.", nextNode: "kitchen_start" },
                    { text: "Use the chalk to draw a protective circle.", nextNode: "ending_48" }
                ]
            },
            kitchen_milk_bottle: {
                text: "You grab the milk bottle. It is surprisingly heavy, almost full, and feels slightly warm.",
                choices: [
                    { text: "Drink the milk (risk of poison).", nextNode: "death_milk_39" },
                    { text: "Pour the milk onto the red symbol.", nextNode: "ending_16" },
                    { text: "Smash the bottle against the red symbol.", nextNode: "ending_symbol_erased" },
                    { text: "Smash the bottle against the window.", nextNode: "death_window_smash_40" }
                ]
            },
            
            // --- Bathroom Path ---
            bathroom_start: {
                text: "The bathroom is warm and humid. The mirror is completely **fogged**. The **sink** contains a thick, black, oil-like liquid that does not move, and the **medicine cabinet** is slightly ajar.",
                choices: [
                    { text: "Wipe the mirror.", nextNode: "bathroom_mirror_wipe" },
                    { text: "Examine the oil in the sink.", nextNode: "bathroom_sink_oil" },
                    { text: "Open the medicine cabinet.", nextNode: "bathroom_cabinet" },
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            bathroom_mirror_wipe: {
                text: "You wipe a circle on the mirror. Your reflection stares back, but it is **grotesque**mouth wide open, eyes black. It is silent, but you can feel its despair.",
                choices: [
                    { text: "Draw a happy face over the grotesque reflection.", nextNode: "ending_13" },
                    { text: "Smash the mirror.", nextNode: "death_mirror_smash_45" },
                    { text: "Return to the bathroom.", nextNode: "bathroom_start" }
                ]
            },
            bathroom_sink_oil: {
                text: "The black liquid is thick and smells faintly of sea salt and old metal. It is not water, and it is not staticit is a liquid map.",
                choices: [
                    { text: "Wash your hands in the oil.", nextNode: "death_oil_poison_46" },
                    { text: "Follow the map (ending).", nextNode: "ending_24" },
                    { text: "Return to the bathroom.", nextNode: "bathroom_start" }
                ]
            },
            bathroom_cabinet: {
                text: "The medicine cabinet is filled with ordinary itemstoothbrushes, gauze, and a single, heavy **pill bottle** that makes no sound when shaken.",
                choices: [
                    { text: "Shake the bottle anyway.", nextNode: "death_rattle_47" },
                    { text: "Take one of the pills.", nextNode: "ending_49" },
                    { text: "Return to the bathroom.", nextNode: "bathroom_start" }
                ]
            },

            // --- Re-entry Points for Logic Loops (Not the beginning of the game) ---
            corridor_start: {
                text: "You are back in the main corridor. The suffocating silence remains.",
                choices: [
                    { text: "Go to the Living Room.", nextNode: "living_room_start" },
                    { text: "Go to the Kitchen.", nextNode: "kitchen_start" },
                    { text: "Check the Bathroom.", nextNode: "bathroom_start" },
                    { text: "Go back to the Bedroom.", nextNode: "bedroom_start" },
                    { text: "Go to the Study (if available).", nextNode: "corridor_study_entrance" },
                    { text: "Wait in the Corridor.", nextNode: "corridor_wait" }
                ]
            },
            living_room_armchair_hatch: {
                text: "The lock requires a four-digit code. You have no idea what it is.",
                choices: [
                    { text: "Return to the corridor.", nextNode: "corridor_start" }
                ]
            },
            
            // --- Final Escape/Resolution Nodes (Placeholder until next stage) ---
            garden_hedge: {
                text: "You find a weak spot in the garden hedge. It's a large, thorny bush, but it feels less substantial than the walls of the house. You can force your way through the wall, emerging safely in the small garden. The hole in the hedge seals instantly behind you.",
                choices: [
                    { text: "Investigate the shed.", nextNode: "garden_shed_2" }
                ]
            },
            
            // --- Endings (54 Total) ---
            
            // Endings 1-30 (Original Endings)
            ending_1: {
                text: "You wake up again, sweat-soaked, the digital clock flickering '3:07 AM'. But this time, you hear the distant, gentle sound of rain outside. The silence is gone. You are safe, for now.",
                endingTitle: "ENDING 1/54: Reawakening",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 1
            },
            ending_chimney: {
                text: "You scramble up the chimney, driven by the journal's cryptic promise. It is a long, dark, suffocating climb. You scrape your hands and face on the brickwork. Just as you feel you can't breathe, you burst out onto the roof, coughing. The air is clear, the rain is audible, and in the distance, you hear sirens. The house is silent behind you, and you leave it there.",
                endingTitle: "ENDING 2/54: The Exit",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 2
            },
            ending_3: {
                text: "The silence breaks not with a sound, but with a color. A brilliant, sapphire blue overwhelms your vision. When it fades, you are standing outside, on a clear, sunny morning, the house replaced by an empty lot. You realize the silence was a filter, not an absence.",
                endingTitle: "ENDING 3/54: Sapphire",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 3
            },
            ending_4: {
                text: "You decide the only way to beat the silence is to join it. You stop moving, stop thinking, stop trying. You enter a state of deep meditation. The house accepts you. You are still there, perfectly motionless and silent, when the sun comes up. You are safe, for now.",
                endingTitle: "ENDING 4/54: Stasis",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 4
            },
            ending_silence_broken: {
                text: "You manage to make a small, audible sounda cough, a whispered word. The silence recoils, shattering like glass. The house fills with the sound of rushing wind and normal ambiance. You are momentarily deafened, but you stumble out the front door and find yourself on a quiet street. The sound is back.",
                endingTitle: "ENDING 5/54: Shattered",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 5
            },
            ending_stay_still: {
                text: "You force yourself to remain perfectly still in the middle of the corridor, not moving a muscle, not making a sound. The silence accepts your obedience. When dawn breaks, the house has returned to normal. You simply walk out. The night passes without incident.",
                endingTitle: "ENDING 6/54: Sanity",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 6
            },
            ending_oil_discovery: {
                text: "You realize the black fluid is not just oil or blood, but crude, undiluted petroleum. You bottle a sample, leave the bathroom, and escape the house without incident, realizing the property holds a major industrial secret.",
                endingTitle: "ENDING 7/54: The Black Gold",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 7
            },
            ending_listen_still: {
                text: "You listen intently. The figure across the street raises a hand and slowly waves. It's a neighbor, confused by your flashlight beam. The silence was just the isolation of the rain and darkness. You go back to bed, embarrassed.",
                endingTitle: "ENDING 8/54: The Misunderstanding",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 8
            },
            ending_symbol_erased: {
                text: "The sound of the glass shattering is deafening, a shockwave of sound that temporarily breaks the silence. The red symbol is scratched and damaged, and the door is dented. The symbol begins to fade slowly, and by dawn, it is gone, along with the oppressive feeling in the kitchen.",
                endingTitle: "ENDING 10/54: The Destroyer",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 10
            },
            ending_11: {
                text: "You find a hidden door in the living room wall disguised as a bookshelf. It opens to a perfectly normal hallway leading to an unalarming front door. You walk out into a clear morning.",
                endingTitle: "ENDING 11/54: The Hidden Way",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 11
            },
            ending_12: {
                text: "You find a hidden key beneath the armchair cushion. It unlocks the front door. You step outside, and the silence immediately gives way to the gentle sounds of a simple, peaceful, sunny morning.",
                endingTitle: "ENDING 12/54: The Key",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 12
            },
            ending_13: {
                text: "You use the flashlight to draw a happy face on the fogged mirror. The warper reflection laughs, but the sound is so silly it loses its power. You leave the bathroom and the house in a state of amused confusion.",
                endingTitle: "ENDING 13/54: Humor",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 13
            },
            ending_14: {
                text: "The hum of the TV is a code. You tap it out on the floor, and a hidden passage opens beneath the armchair.",
                endingTitle: "ENDING 14/54: The Code",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 14
            },
            ending_15: {
                text: "The symbol is a portal. When you step on it, the floor beneath you vanishes. You fall for a brief, silent moment before landing hard in your own bed, outside the time loop. You hear the gentle sound of rain outside. You are free.",
                endingTitle: "ENDING 15/54: The Portal",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 15
            },
            ending_16: {
                text: "The milk instantly dissolves the symbol, which shimmers and evaporates. A high-pitched, silent signal travels from the kitchen. The front door unlocks.",
                endingTitle: "ENDING 16/54: The Signal",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 16
            },
            ending_17: {
                text: "You remember the exact coordinates of the house from a recent map check. By concentrating on them, you realize the house is an illusion created by your mind. The corridor dissolves, and you wake up in your own bed.",
                endingTitle: "ENDING 17/54: The Map-Mind",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 17
            },
            ending_18: {
                text: "You find a hidden hatch in the bedroom floor. It leads to a storm drain, which you navigate until you emerge on a nearby street. The drain water is deafeningly loud, confirming your escape.",
                endingTitle: "ENDING 18/54: The Drain",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 18
            },
            ending_19: {
                text: "You decide to walk the perimeter of the house, touching every wall and door in a specific sequence. This act of methodical movement breaks the spatial anomaly. The front door opens to a bright morning.",
                endingTitle: "ENDING 19/54: The Map",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 19
            },
            ending_20: {
                text: "You draw a sketch of the house, including the red symbol. By externalizing the fear, you make it controllable. The front door opens.",
                endingTitle: "ENDING 20/54: Externalization",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 20
            },
            ending_21: {
                text: "You go back to the kitchen and organize all the frozen items by date. The act of imposed order breaks the anomaly's chaos. The house returns to normal.",
                endingTitle: "ENDING 21/54: Order",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 21
            },
            ending_22: {
                text: "You shout 'I refuse to be silent!' at the top of your lungs. The sound is a shockwave. The house shudders and dissolves. You wake up outside.",
                endingTitle: "ENDING 22/54: Refusal",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 22
            },
            ending_23: {
                text: "You realize the red symbol is an old fear pattern. By consciously rejecting the symbol's meaning, you break its connection to your personal fear.",
                endingTitle: "ENDING 23/54: Severed Link",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 23
            },
            ending_24: {
                text: "The bathroom sink oil is a map. You spread it on the floor, and it points to a tiny pinprick of lightthe front door. You follow the path and escape.",
                endingTitle: "ENDING 24/54: The Oily Map",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 24
            },
            ending_25: {
                text: "You find a hidden safe in the bedroom closet. Inside is a note: 'It was only a dream.' You wake up, and it was.",
                endingTitle: "ENDING 25/54: Only a Dream",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 25
            },
            ending_26: {
                text: "Flipping the switch causes a massive, silent grinding sound from behind the fireplace. The brick wall slides open, revealing a clear, brightly lit exit to the outside.",
                endingTitle: "ENDING 26/54: The Switch",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 26
            },
            ending_27: {
                text: "You wait in the corridor. You close your eyes and focus on the darkness. When you open them, it is morning, and the house is completely normal. You simply walk out.",
                endingTitle: "ENDING 27/54: Endurance",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 27
            },
            ending_28: {
                text: "Your rhythmic tapping begins to create an audible sound, a tiny drumbeat against the silence. The rhythm attracts something from the walls. A key falls at your feet. You use it on the front door.",
                endingTitle: "ENDING 28/54: The Rhythm",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 28
            },
            ending_29: {
                text: "You follow a silent, buzzing feeling that leads you to the window. You climb out, scaling the wall of the house to the roof, where a helicopter is waiting. They tell you it's a rescue.",
                endingTitle: "ENDING 29/54: The Rescue",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 29
            },
            ending_30: {
                text: "You break a small piece of wood off a chair and chew on it. The silent crunching grounds you to reality. The front door opens.",
                endingTitle: "ENDING 30/54: Grounded",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 30
            },
            
            // Death Endings 31-54 (Original: 31-42, New: 43-54)
            death_crisper: {
                text: "You open the crisper drawer. It is full of human teeth. The sheer silent horror overwhelms your senses, causing a painless, immediate heart failure.",
                endingDescription: "Silent heart failure.",
                isDeath: true,
                endingId: 33,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_tv_touch: {
                text: "You touch the red-pulsing screen. The static flows into your body, freezing your blood instantly. You stand there, a silent statue of ice.",
                endingDescription: "Frozen blood.",
                isDeath: true,
                endingId: 34,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_armchair_sit: {
                text: "You sit in the armchair. It clamps shut on you, silently suffocating you into the cushion.",
                endingDescription: "Silent suffocation.",
                isDeath: true,
                endingId: 35,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_garden_shed: {
                text: "You check the shed. It is full of silent, ticking clocks. The lack of sound drives you insane with a cacophony of internal ticks.",
                endingDescription: "Internal clocks.",
                isDeath: true,
                endingId: 36,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_shed_touch: {
                text: "You touch the shed. It is freezing. The cold seeps into your body, paralyzing you in a state of sheer terror.",
                endingDescription: "Sheer terror.",
                isDeath: true,
                endingId: 37,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_wipe_symbol: {
                text: "You try to wipe the symbol off. The red paint is corrosive. It burns through your skin, your muscle, and your bone until your hand is nothing but a charred stump.",
                endingDescription: "The corrosive symbol.",
                isDeath: true,
                endingId: 38,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_milk_39: {
                text: "You drink the milk. It is room temperature, thick, and tastes metallic. It is not milk. You feel your throat close up and your blood turn to sludge.",
                endingDescription: "Poisoned milk.",
                isDeath: true,
                endingId: 39,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_window_smash_40: {
                text: "You smash the milk bottle against the window. The sound is a dull, flat thudnot the expected shattering crash. The glass does not break. The silence pushes back, forcing the glass shards deep into your flesh.",
                endingDescription: "Glass shards.",
                isDeath: true,
                endingId: 40,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_jump_41: {
                text: "You jump out the window, aiming for a nearby roof. You miss. The fall is completely silent, and the impact is a brief, painless burst of darkness.",
                endingDescription: "Silent fall.",
                isDeath: true,
                endingId: 41,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_window_climb: {
                text: "You try to climb the brick wall. A brick comes loose, then another. You slip, falling to your death on the unseen street below.",
                endingDescription: "Bricks of betrayal.",
                isDeath: true,
                endingId: 42,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            
            // --- NEW Endings (IDs 43-54) ---
            ending_the_composer_43: { // from study_bookshelf_2
                text: "You take the book. As your fingers brush the cover, you are overwhelmed by a thousand tiny, beautiful soundsthe rustle of leaves, a child's laugh, a distant bell. You realize the house is not silent, but is *storing* all sound. By holding the Compendium, you become the house's conductor, and you conduct yourself safely out.",
                endingTitle: "ENDING 43/54: The Composer",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 43
            },
            death_bird_release_44: { // from study_bookshelf_2
                text: "You open the cage and release the bird. It does not fly, but simply falls to the floor, where it begins to rapidly decay, turning to dust. The dust flies into your face, and the last thing you see is the birdcage snapping shut on your head.",
                endingDescription: "The silent dust.",
                isDeath: true,
                endingId: 44,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_mirror_smash_45: { // from bathroom_mirror_wipe
                text: "You smash the mirror with your flashlight. The glass shatters, but the sound is swallowed. The grotesque reflection's face splits into a thousand shards, and each one of them reflects a terrifying, silent future for you. You are overwhelmed by the images and lose your mind.",
                endingDescription: "Thousand reflections.",
                isDeath: true,
                endingId: 45,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_oil_poison_46: { // from bathroom_sink_oil
                text: "You wash your hands in the oil. It seeps into your skin, cold and numbing. The oil is a living thing; it crawls up your arms, seeking your heart. You feel your pulse slow and fade into the silence.",
                endingDescription: "Living oil.",
                isDeath: true,
                endingId: 46,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            death_rattle_47: { // from bathroom_cabinet
                text: "You shake the pill bottle. The faint rattle is the only sound. The sound is so small, so isolated, that the house focuses all its silent energy on it, and then on you. You feel a massive pressure build inside your skull until it bursts.",
                endingDescription: "Pressure overload.",
                isDeath: true,
                endingId: 47,
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }]
            },
            ending_48: { // from kitchen_behind_freezer
                text: "You quickly draw a protective chalk circle on the kitchen floor, outside the red symbol. You step inside the circle, and the house's silent power cannot reach you. You wait there, safely, until dawn.",
                endingTitle: "ENDING 48/54: Sanctuary",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 48
            },
            ending_49: { // from bathroom_cabinet
                text: "You swallow a pill from the bottle. It is not medicine, but a silent chemical sedative. You fall into a deep, dreamless sleep. When you wake up, you are outside, wrapped in a blanket, staring at the house from a distance.",
                endingTitle: "ENDING 49/54: Sedation",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 49
            },
            ending_50: {
                text: "You find a weak spot in the garden hedge. It's a large, thorny bush, but it feels less substantial than the walls of the house. You can force your way through the wall, emerging safely in the small garden. The hole in the hedge seals instantly behind you. You escape through the gate.",
                endingTitle: "ENDING 50/54: Breakthrough",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 50
            },
            ending_51: {
                text: "You use your flashlight to write a message on the dusty living room floor: 'I am here.' The house replies by opening the front door.",
                endingTitle: "ENDING 51/54: Acknowledgment",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 51
            },
            ending_52: {
                text: "You stand in the corridor and close your eyes. You imagine the loudest, most chaotic sound you can think ofa thunderstorm, an earthquake, a crowd screaming. The intensity of the imagined noise forces the house's silence to retreat. When you open your eyes, you are free.",
                endingTitle: "ENDING 52/54: The Inner Sound",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 52
            },
            ending_53: {
                text: "The reflection in the mirror is the key. You stare at it until it becomes a perfect, non-grotesque image of you. The reflection smiles and nods, and the house instantly becomes normal. You walk out.",
                endingTitle: "ENDING 53/54: Self-Acceptance",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 53
            },
            ending_54: {
                text: "You manage to open the latch on the armchair. Beneath it is a simple key and a note: 'The house is a museum of sound. Please be quiet.' You take the key and let yourself out.",
                endingTitle: "ENDING 54/54: The Museum",
                choices: [{ text: "Return to Title Screen", nextNode: "title_screen" }],
                isEnding: true,
                endingId: 54
            },

            // Node to trigger game exit from ending
            title_screen: {
                isTitle: true,
                text: "The nightmare retreats. The Silent Corridor awaits your return.",
                choices: [] 
            }
        };

        // Function to calculate the TOTAL_ENDINGS based on storyNodes
        function calculateTotalEndings() {
            let count = 0;
            for (const key in window.storyNodes) {
                const node = window.storyNodes[key];
                if (node.isEnding || node.isDeath) {
                    count++;
                }
            }
            TOTAL_ENDINGS = count;
        }

        // --- Core Game Functions ---

        // Function to handle game over/ending screen
        function showEnding(node) {
             // === BUG FIX START: Ensure Return to Title Screen button for all endings/deaths ===
            // This line guarantees that all endings and deaths will have a single button
            // to return to the title screen, fixing the issue where some endings failed to display it.
            node.choices = [{ text: "Return to Title Screen", nextNode: "title_screen" }];
             // === BUG FIX END ===
            
            // 1. Mark as unlocked in localStorage
            const unlockedEndings = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            // Find the node key by its endingId (Id 1-54)
            const nodeKey = Object.keys(window.storyNodes).find(key => 
                window.storyNodes[key].endingId === node.endingId && (window.storyNodes[key].isEnding || window.storyNodes[key].isDeath)
            );
            if (nodeKey && !unlockedEndings.includes(nodeKey)) {
                unlockedEndings.push(nodeKey);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(unlockedEndings));
            }

            // DYNAMIC TITLE GENERATION
            const prefix = node.isEnding ? "ENDING" : "GAME OVER";
            let dynamicTitle;
            if (node.isEnding) {
                 // Main endings replace the X/Y part (e.g., 1/30) with the dynamic endingId/TOTAL_ENDINGS (e.g., 1/54)
                dynamicTitle = node.endingTitle.replace(/(\d+)\/(\d+)/, `${node.endingId}/${TOTAL_ENDINGS}`);
            } else {
                 // Death endings use the GAME OVER prefix, and a format like (31/54)
                dynamicTitle = `${prefix} (${node.endingId}/${TOTAL_ENDINGS}): ${node.endingDescription}`;
            }

            let htmlContent = `
                <h2>${dynamicTitle}</h2>
                <p class="description">${node.text}</p>
            `;
            
            stopBlinking(); // Stop blinking on game over/ending
            
            // Apply a CSS class to the container for game over styling
            gameContainerEl.classList.add('game-over'); 

            // Update content and fade in
            storyTextEl.innerHTML = htmlContent;
            renderChoices(node.choices);
            storyTextEl.style.opacity = '1';
            choicesEl.style.opacity = '1';
        }

        // Function to render the current story node content
        function showStoryNode(nodeKey) {
            const node = window.storyNodes[nodeKey];
            if (!node) {
                console.error("Node not found:", nodeKey);
                return;
            }

            // Clear game over state if returning from an ending
            gameContainerEl.classList.remove('game-over'); 

            let htmlContent;
            if (node.isEnding || node.isDeath) {
                // If it's an ending/death, use the special ending function
                showEnding(node);
                return;
            } else if (node.isTitle) {
                // If the node is a title node, ensure the game screen is set up
                htmlContent = `
                    <h2>${nodeKey === 'start' ? '3:07 AM' : 'The Nightmare Returns'}</h2>
                    <p class="description">${node.text}</p>
                `;
                // FIX: Blinking is now handled by `applySettings` on load/return, 
                // and should be restarted by `startBlinking()` in `applySettings` call.
            } else {
                // Normal story node
                 htmlContent = `<p class="description">${node.text}</p>`;
            }

            // 1. Update the content
            storyTextEl.innerHTML = htmlContent;
            renderChoices(node.choices);

            // 2. Fade content back in
            // This is critical: if content was changed after fade-out, 
            // the new content needs to fade in now.
            setTimeout(() => {
                storyTextEl.style.opacity = '1';
                choicesEl.style.opacity = '1';
            }, 50); // Small delay to ensure browser registers the content update
        }

        // Function to render the choice buttons
        function renderChoices(choices) {
            choicesEl.innerHTML = ''; // Clear previous choices
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.classList.add('choice-btn');
                button.textContent = choice.text;
                button.addEventListener('click', () => handleInGameTransition(choice.nextNode));
                choicesEl.appendChild(button);
            });
        }
        
        // --- Screen Management Functions ---

        function handleStartScreenClick(callback) {
            startAmbiance(); // Attempt to start audio on first interaction
            callback();
        }

        // Function to switch between start, settings, and game screens
        function showScreen(screenId) {
            if (screenId === 'start') {
                // Clear any active game state classes
                gameScreenEl.classList.remove('active', 'fade-out');
                gameContainerEl.classList.remove('game-over'); 
                
                // Reset title opacity
                gameTitleEl.style.opacity = '1';

                // 1. Make the start screen active
                startScreenEl.classList.add('active'); 
                
                // RESTART BLINKING: Re-apply settings to restart the blinking timer if enabled (after game over)
                applySettings(); // FIX: Ensures blinking restarts when returning to start screen.
                
                // 2. Small timeout to ensure the browser registers opacity: 0 before triggering transition
                setTimeout(() => {
                    // 3. Remove the fade-out class to transition opacity back to 1 (1.0s)
                    startScreenEl.classList.remove('fade-out');
                }, 50); // Small delay

            } else if (screenId === 'game') {
                // 1. Make the start screen fade out over 1.0s
                startScreenEl.classList.add('fade-out');
                
                // Close the sidebar if it's open when starting the game
                if(sidebarEl.classList.contains('open')) {
                    toggleEndingsMenu();
                }
                
                // Close settings if it's open
                settingsScreenEl.classList.remove('active');

                // The first delay allows the start screen to fully fade out (1.0s transition)
                // CORRECTION: Set time to 1000ms to match CSS and quick flow request.
                setTimeout(() => {
                    // A. Deactivate the start screen (hiding it) and start the game screen fade-in (1.0s fade)
                    startScreenEl.classList.remove('active'); // <-- ACTIVE is removed ONLY after fade is complete
                    gameScreenEl.classList.add('active'); 
                    
                    // B. After the game screen is fully visible (1.0s), trigger the content fade (1.5s)
                    setTimeout(() => {
                        // Load and fade-in the content
                        showStoryNode('start');
                    }, 1000); // Delay for the container fade (1.0s)
                    
                }, 1000); // Delay for the start screen fade (1.0s)
            }
        }

        // Manages the in-game transition fade-out and content swap.
        function handleInGameTransition(nextNode) {
            
            // If transitioning back to the title screen from an ending/death
            if (nextNode === 'title_screen') {
                // Apply the fade-out class to the whole game screen container (1.0s transition)
                gameScreenEl.classList.add('fade-out');
                gameTitleEl.style.opacity = '0';
                stopBlinking(); // Stop blinking on exit

                // Wait for the full game screen fade-out duration (1.0s)
                setTimeout(() => {
                    showScreen('start');
                }, 1000);
                return;
            }

            // For normal node transitions: fade out content (1.5s)
            storyTextEl.style.opacity = '0';
            choicesEl.style.opacity = '0';
            
            // Title opacity stays the same, though it usually stays (keep it at 1 for atmosphere)

            // 2. Wait for the content fade-out duration (1.5s)
            setTimeout(() => {
                // 3. Update the content
                showStoryNode(nextNode);
            }, STORY_TRANSITION_DURATION_MS);
        }

        // --- Endings Menu Logic (Unchanged) ---
        window.populateEndingsList = function() {
            listContentEl.innerHTML = ''; // Clear existing list content

            // 1. Load unlocked endings from local storage
            const unlockedEndings = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            // 2. Create a list of all ending/death nodes, sorted by ID
            const allNodes = Object.keys(window.storyNodes)
                .map(key => ({ ...window.storyNodes[key], key }))
                .filter(node => node.isEnding || node.isDeath)
                .sort((a, b) => a.endingId - b.endingId);

            // 3. Render each ending item
            allNodes.forEach(node => {
                const isUnlocked = unlockedEndings.includes(node.key);
                
                // DYNAMIC TITLE GENERATION for the display name
                const prefix = node.isEnding ? "ENDING" : "DEATH";
                let dynamicTitle;
                if (node.isEnding) {
                     // Main endings replace the X/Y part (e.g., 1/30) with the dynamic endingId/TOTAL_ENDINGS (e.g., 1/54)
                    dynamicTitle = node.endingTitle.replace(/(\d+)\/(\d+)/, `${node.endingId}/${TOTAL_ENDINGS}`);
                } else {
                     // Death endings use the GAME OVER prefix, and a format like (31/54)
                    dynamicTitle = `${prefix} (${node.endingId}/${TOTAL_ENDINGS}): ${node.endingDescription}`;
                }

                const item = document.createElement('div');
                item.classList.add('ending-item');
                
                if (isUnlocked) {
                    item.classList.add('unlocked');
                }
                
                const statusSymbol = isUnlocked ? '' : '';
                
                // Split the generated dynamic title into the number/prefix part and the name part
                const parts = dynamicTitle.split(':');
                const prefixAndNumber = parts[0].trim();
                const cleanName = parts.slice(1).join(':').trim();

                item.innerHTML = `
                    <span class="ending-name">${prefixAndNumber} - ${cleanName}</span>
                    <span class="status">${statusSymbol}</span>
                `;
                listContentEl.appendChild(item);
            });
            
            // Add a completion status at the top of the list
            const unlockedCount = unlockedEndings.length;
            const statusHeader = document.createElement('h4');
            statusHeader.style.color = unlockedCount === TOTAL_ENDINGS ? '#44ff44' : '#f55'; /* Light red/green status */
            statusHeader.style.textAlign = 'center';
            statusHeader.style.marginTop = '20px';
            statusHeader.innerHTML = `**Status:** ${unlockedCount}/${TOTAL_ENDINGS} Found`;
            listContentEl.prepend(statusHeader);

        }

        // Function to toggle the sidebar menu
        function toggleEndingsMenu() {
            startAmbiance(); // Ensure audio starts on first click
            window.populateEndingsList();
            sidebarEl.classList.toggle('open');
            document.body.classList.toggle('sidebar-open');
        }
        
        window.toggleEndingsMenu = toggleEndingsMenu; // Expose to global scope for HTML onclick

        // --- Audio Management Logic (Unchanged) ---
        function startAmbiance() {
            if (rainAmbiance.paused) {
                // Check if browser allows autoplay and try to start
                const playPromise = rainAmbiance.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // Autoplay started!
                    }).catch(error => {
                        // Autoplay prevented. User must interact first.
                        console.log("Autoplay prevented. Audio will start on the next user interaction.");
                    });
                }
            }
        }

        // --- Event Listeners and Initialization (Unchanged) ---
        
        // Start Button: Wraps the screen change to ensure audio starts
        startButtonEl.addEventListener('click', () => handleStartScreenClick(() => showScreen('game')));

        // Settings Button: Wraps the screen change to ensure audio starts
        settingsButtonEl.addEventListener('click', () => handleStartScreenClick(toggleSettingsMenu));

        // Settings Save Button: Does not need the wrapper as it's not a *first* click event.
        settingsSaveButtonEl.addEventListener('click', saveSettings);
        
        // Mouse movement for flashlight and eye tracking
        document.addEventListener('mousemove', (e) => {
            // 1. Flashlight (Always active)
            document.body.style.setProperty('--x', `${e.clientX}px`);
            document.body.style.setProperty('--y', `${e.clientY}px`);
            
            // 2. Eye Tracking (Only active on 'better' graphics and if eyes are rendered)
            if (gameSettings.graphics === 'better') {
                trackEyes(e.clientX, e.clientY);
            }
        });

        
        // Re-render eyes on window resize to maintain non-overlapping constraint
        window.addEventListener('resize', () => {
            if (gameSettings.graphics === 'better') {
                eyePositions = []; // Force regeneration on resize
                renderEyes();
            }
        });


        // Initialize the game state when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadAndApplySettings(); 
            window.populateEndingsList(); // Ensure list is ready
            calculateTotalEndings();
            showScreen('start');
        });
        
    </script>
</body>
</html>
